<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Inglés Básico - Módulo 1</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Poppins:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos CSS integrados (Manteniendo los mismos que ya tenías) */
        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Alinea al inicio verticalmente */
            min-height: 100vh;
            margin: 20px;
            color: #333;
            line-height: 1.6;
        }

        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            max-width: 900px;
            width: 100%;
            margin-top: 30px; /* Margen superior para que no esté pegado al borde */
        }

        h1 {
            font-family: 'Poppins', sans-serif;
            color: #4338ca;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }

        h2 {
            font-family: 'Poppins', sans-serif;
            color: #4338ca;
            font-size: 1.6em;
            margin-bottom: 15px;
        }

        h3 {
            font-family: 'Poppins', sans-serif;
            color: #5b50d8;
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .card {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.03);
        }

        .hidden {
            display: none;
        }

        /* Instrucciones */
        #instructions ul {
            list-style: disc;
            padding-left: 25px;
            margin-bottom: 20px;
        }

        #instructions ul li {
            margin-bottom: 8px;
        }

        /* Botones */
        button {
            background-color: #4338ca;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: inline-block; /* Para botones de navegación */
            margin: 20px 10px 0;
        }

        button.nav-btn {
            background-color: #007bff;
        }
        button.nav-btn:hover {
            background-color: #0056b3;
        }
        button.finish-btn {
            background-color: #dc3545;
        }
        button.finish-btn:hover {
            background-color: #c82333;
        }
        button:hover {
            background-color: #372e9d;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        /* Contenedor de botones de navegación */
        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .button-group.center {
            justify-content: center;
        }

        /* Formulario de datos del estudiante */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input[type="text"],
        .form-group input[type="email"] {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }

        .error-message {
            color: #dc3545;
            font-weight: 600;
            margin-top: 10px;
            text-align: center;
        }

        /* Contenido de la prueba */
        .timer {
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
            text-align: right;
            margin-bottom: 20px;
            padding: 10px 15px;
            background-color: #eaf6ff;
            border-radius: 8px;
            border: 1px solid #b3d9ff;
        }

        .question-block {
            margin-bottom: 30px;
            padding-bottom: 20px;
            /* No border-bottom aquí para que los bloques puedan navegar sin interrupciones visuales */
        }

        .question-block:last-of-type {
            border-bottom: none;
            margin-bottom: 0;
        }

        .question-block p {
            margin-bottom: 15px;
        }

        .options label {
            display: block;
            margin-bottom: 10px;
            cursor: pointer;
            background-color: #f0f0f0;
            padding: 12px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .options label:hover {
            background-color: #e5e5e5;
        }

        .options input[type="radio"],
        .options input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.1);
        }

        /* Estilos para inputs de texto en preguntas */
        .q2-input, .q5-input {
            width: 200px; /* Ancho fijo para los inputs de texto */
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
            margin: 0 5px;
            box-sizing: border-box; /* Incluye padding y borde en el ancho total */
        }

        /* Retroalimentación (oculta en la interfaz) */
        .feedback {
            display: none !important;
        }

        /* Botones de verificar respuestas (ocultos en la interfaz) */
        .check-answers-btn {
            display: none !important;
        }

        /* Resumen de resultados */
        #results-summary {
            text-align: center;
            padding: 40px;
        }

        #results-summary p {
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        #final-score {
            font-size: 1.8em;
            color: #4338ca;
        }

        @media (max-width: 768px) {
            .container {
                margin: 15px;
                padding: 20px;
            }
            h1 {
                font-size: 1.8em;
            }
            h2 {
                font-size: 1.4em;
            }
            button {
                padding: 10px 20px;
                font-size: 0.9em;
            }
            .form-group input, .q2-input, .q5-input {
                width: 100%; /* En pantallas pequeñas, ocupan todo el ancho */
                margin: 5px 0;
            }
            .button-group {
                flex-direction: column;
                align-items: center;
            }
            .button-group button {
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Prueba Interactiva de Inglés Básico - Módulo 1</h1>

        <div id="student-data" class="card">
            <h2>1. Datos del Estudiante</h2>
            <p>Por favor, ingresa tus datos para iniciar la prueba.</p>
            <div class="form-group">
                <label for="name">Nombre(s):</label>
                <input type="text" id="name" required>
            </div>
            <div class="form-group">
                <label for="surname">Apellido(s):</label>
                <input type="text" id="surname" required>
            </div>
            <div class="form-group">
                <label for="email">Correo Electrónico:</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="id-card">Cédula de Identidad:</label>
                <input type="text" id="id-card" required>
            </div>
            <div class="button-group center">
                <button id="submit-data-btn">Validar y Continuar</button>
            </div>
            <p id="id-error" class="error-message"></p>
        </div>

        <div id="instructions" class="card hidden">
            <h2>Instrucciones Importantes:</h2>
            <ul>
                <li>La prueba tiene una duración máxima de **120 minutos**. Asegúrate de tener suficiente tiempo antes de comenzar.</li>
                <li>Una vez que comiences, no podrás pausar el tiempo.</li>
                <li>Todas tus respuestas serán evaluadas al finalizar la prueba.</li>
                <li>La puntuación total de la prueba es de 20 puntos, distribuidos equitativamente entre las opciones correctas.</li>
                <li>Al finalizar, tus resultados y una **retroalimentación detallada** serán enviados automáticamente al correo electrónico de la institución.</li>
            </ul>
            <div class="button-group center">
                <button id="start-test-btn">Iniciar Prueba</button>
            </div>
        </div>

        <div id="test-content" class="card hidden">
            <div class="timer">Tiempo Restante: <span id="time">120:00</span></div>

            <div class="question-block" data-question-index="0" data-question="q1">
                <h3>Pregunta 1: Días de la semana <small>(4 puntos)</small></h3>
                <p><strong>Pregunta:</strong> Select the correct order. Seleccione el orden correcto:</p>
                <div class="options">
                    <label><input type="radio" name="q1" value="a"> a) Wednesday, Monday, Tuesday, Thursday, Friday, Saturday, Sunday</label>
                    <label><input type="radio" name="q1" value="b"> b) Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday</label>
                    <label><input type="radio" name="q1" value="c"> c) Monday, Thursday, Wednesday, Tuesday, Friday, Saturday, Sunday</label>
                    <label><input type="radio" name="q1" value="d"> d) Monday, Tuesday, Wednesday, Thursday, Friday, Sunday, Saturday</label>
                </div>
                <div class="button-group">
                    <button class="nav-btn" data-nav="prev">Atrás</button>
                    <button class="nav-btn" data-nav="next">Siguiente</button>
                </div>
            </div>

            <div class="question-block hidden" data-question-index="1" data-question="q2">
                <h3>Pregunta 2: Oraciones negativas con “To be” <small>(7 puntos)</small></h3>
                <p><strong>Pregunta:</strong> Complete the sentences with the correct negative form. Complete las oraciones negativas con la forma correcta:</p>
                <ol>
                    <li>I <input type="text" class="q2-input" id="q2-1"> a student.</li>
                    <li>They <input type="text" class="q2-input" id="q2-2"> at home.</li>
                    <li>He <input type="text" class="q2-input" id="q2-3"> a doctor.</li>
                    <li>She <input type="text" class="q2-input" id="q2-4"> happy.</li>
                    <li>We <input type="text" class="q2-input" id="q2-5"> ready.</li>
                    <li>It <input type="text" class="q2-input" id="q2-6"> sunny.</li>
                    <li>You <input type="text" class="q2-input" id="q2-7"> tired.</li>
                </ol>
                <div class="button-group">
                    <button class="nav-btn" data-nav="prev">Atrás</button>
                    <button class="nav-btn" data-nav="next">Siguiente</button>
                </div>
            </div>

            <div class="question-block hidden" data-question-index="2" data-question="q3">
                <h3>Pregunta 3: Meses del año <small>(4 puntos)</small></h3>
                <p><strong>Pregunta:</strong> Which of these are months of the year?. Cuál de estos son meses del año?:</p>
                <div class="options">
                    <label><input type="checkbox" name="q3" value="a"> a) January</label>
                    <label><input type="checkbox" name="q3" value="b"> b) Morning</label>
                    <label><input type="checkbox" name="q3" value="c"> c) Saturday</label>
                    <label><input type="checkbox" name="q3" value="d"> d) April</label>
                    <label><input type="checkbox" name="q3" value="e"> e) Friday</label>
                    <label><input type="checkbox" name="q3" value="f"> f) December</label>
                    <label><input type="checkbox" name="q3" value="g"> g) August</label>
                </div>
                <div class="button-group">
                    <button class="nav-btn" data-nav="prev">Atrás</button>
                    <button class="nav-btn" data-nav="next">Siguiente</button>
                </div>
            </div>

            <div class="question-block hidden" data-question-index="3" data-question="q4">
                <h3>Pregunta 4: Números cardinales y ordinales <small>(4 puntos)</small></h3>
                <p><strong>Pregunta:</strong> Choose the correct ordinal numbers. Escoja los números ordinales:</p>
                <div class="options">
                    <label><input type="checkbox" name="q4" value="a"> a) First</label>
                    <label><input type="checkbox" name="q4" value="b"> b) Three</label>
                    <label><input type="checkbox" name="q4" value="c"> c) Second</label>
                    <label><input type="checkbox" name="q4" value="d"> d) Twelve</label>
                    <label><input type="checkbox" name="q4" value="e"> e) Third</label>
                    <label><input type="checkbox" name="q4" value="f"> f) Fifth</label>
                    <label><input type="checkbox" name="q4" value="g"> g) Eighteen</label>
                </div>
                <div class="button-group">
                    <button class="nav-btn" data-nav="prev">Atrás</button>
                    <button class="nav-btn" data-nav="next">Siguiente</button>
                </div>
            </div>

            <div class="question-block hidden" data-question-index="4" data-question="q5">
                <h3>Pregunta 5: Interrogativas con “To be” <small>(6 puntos)</small></h3>
                <p><strong>Pregunta:</strong> Transform the following positive sentences into interrogative sentences. Transforme las siguientes oraciones positivas a oraciones interrogativas:</p>
                <ol>
                    <li>You are okay <input type="text" class="q5-input" id="q5-1"></li>
                    <li>They are hungry <input type="text" class="q5-input" id="q5-2"></li>
                    <li>He is a teacher <input type="text" class="q5-input" id="q5-3"></li>
                    <li>We are ready <input type="text" class="q5-input" id="q5-4"></li>
                    <li>She is at school <input type="text" class="q5-input" id="q5-5"></li>
                    <li>They are friends <input type="text" class="q5-input" id="q5-6"></li>
                </ol>
                <div class="button-group">
                    <button class="nav-btn" data-nav="prev">Atrás</button>
                    <button class="finish-btn" id="finish-test-btn">Finalizar Prueba</button>
                </div>
            </div>
        </div>

        <div id="results-summary" class="card hidden">
            <h2>Resultados de la Prueba</h2>
            <p>¡Gracias por completar la prueba! Tus resultados han sido enviados a tu correo electrónico.</p>
            <p>Tu puntuación final es: <strong id="final-score"></strong> puntos de 20.</p>
        </div>
    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        // Configuración inicial de EmailJS
        (function() {
            emailjs.init({
                publicKey: "7FE4lqcCZ69cThSp_", // Tu Public Key
            });
        })();

        // Lógica de JavaScript integrada
        document.addEventListener('DOMContentLoaded', () => {
            // Referencias a los elementos del DOM
            const instructionsSection = document.getElementById('instructions');
            const studentDataSection = document.getElementById('student-data');
            const testContentSection = document.getElementById('test-content');
            const resultsSummarySection = document.getElementById('results-summary');

            const startTestBtn = document.getElementById('start-test-btn');
            const submitDataBtn = document.getElementById('submit-data-btn');
            const finishTestBtn = document.getElementById('finish-test-btn');

            const nameInput = document.getElementById('name');
            const surnameInput = document.getElementById('surname');
            const emailInput = document.getElementById('email');
            const idCardInput = document.getElementById('id-card');
            const idError = document.getElementById('id-error');

            const timerDisplay = document.getElementById('time');
            const finalScoreDisplay = document.getElementById('final-score');

            const questionBlocks = document.querySelectorAll('.question-block');
            let currentQuestionIndex = 0;

            let studentName = '';
            let studentSurname = '';
            let studentEmail = '';
            let studentIdCard = '';
            let score = 0;
            let timerInterval;
            let timeLeft = 120 * 60; // 120 minutos en segundos
            let startTime; // Para calcular el tiempo de respuesta

            // Variables para almacenar la retroalimentación y el estado para EmailJS
            let feedbackQ1 = '';
            let feedbackQ2 = '';
            let feedbackQ3 = '';
            let feedbackQ4 = '';
            let feedbackQ5 = '';
            let comprehensionLevel = 'Básico'; // Valor por defecto
            let testStatus = 'Completado';
            let responseTime = 'N/A'; // Tiempo que tardó el estudiante

            // Cédulas autorizadas y acceso ilimitado
            const authorizedIds = ['26774669', '30521171', '10182240'];
            const unlimitedAccessId = '3716064';

            // Respuestas correctas
            const correctAnswers = {
                q1: { value: 'b', text: 'Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday' },
                q2: [
                    { regex: /^(am\s*not|i'm\s*not)$/i, example: 'am not / I\'m not' },
                    { regex: /^(are\s*not|aren't)$/i, example: 'are not / aren\'t' },
                    { regex: /^(is\s*not|isn't)$/i, example: 'is not / isn\'t' },
                    { regex: /^(is\s*not|isn't)$/i, example: 'is not / isn\'t' },
                    { regex: /^(are\s*not|aren't)$/i, example: 'are not / aren\'t' },
                    { regex: /^(is\s*not|isn't)$/i, example: 'is not / isn\'t' },
                    { regex: /^(are\s*not|aren't)$/i, example: 'are not / aren\'t' }
                ],
                q3: { values: ['a', 'd', 'f', 'g'], texts: ['January', 'April', 'December', 'August'] },
                q4: { values: ['a', 'c', 'e', 'f'], texts: ['First', 'Second', 'Third', 'Fifth'] },
                q5: [
                    { regex: /^are you okay\??$/i, example: 'Are you okay?' },
                    { regex: /^are they hungry\??$/i, example: 'Are they hungry?' },
                    { regex: /^is he a teacher\??$/i, example: 'Is he a teacher?' },
                    { regex: /^are we ready\??$/i, example: 'Are we ready?' },
                    { regex: /^is she at school\??$/i, example: 'Is she at school?' },
                    { regex: /^are they friends\??$/i, example: 'Are they friends?' }
                ]
            };

            // Puntuación por pregunta
            const questionPoints = {
                q1: 4,
                q2: 1, // Por cada sub-pregunta
                q3: 1, // Por cada opción correcta seleccionada
                q4: 1, // Por cada opción correcta seleccionada
                q5: 1  // Por cada sub-pregunta
            };

            // --- Funciones de control de flujo ---

            // Muestra la pregunta actual y oculta las demás
            function showQuestion(index) {
                questionBlocks.forEach((block, i) => {
                    if (i === index) {
                        block.classList.remove('hidden');
                    } else {
                        block.classList.add('hidden');
                    }
                });
                // Ocultar botón "Atrás" en la primera pregunta
                const prevButton = questionBlocks[index].querySelector('[data-nav="prev"]');
                if (prevButton) {
                    prevButton.style.display = (index === 0) ? 'none' : 'inline-block';
                }
                // Ocultar botón "Siguiente" y mostrar "Finalizar" en la última pregunta
                const nextButton = questionBlocks[index].querySelector('[data-nav="next"]');
                const finishButton = questionBlocks[index].querySelector('#finish-test-btn');
                if (nextButton) {
                    nextButton.style.display = (index === questionBlocks.length - 1) ? 'none' : 'inline-block';
                }
                if (finishButton) {
                    finishButton.style.display = (index === questionBlocks.length - 1) ? 'inline-block' : 'none';
                }
            }


            // Iniciar el temporizador
            function startTimer() {
                startTime = Date.now(); // Marca el inicio del test
                timerInterval = setInterval(() => {
                    timeLeft--;
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        testStatus = 'Tiempo agotado';
                        alert('¡Se acabó el tiempo! La prueba ha finalizado.');
                        submitTest(true); // Enviar la prueba automáticamente
                    }
                }, 1000);
            }

            // Ocultar todas las secciones
            function hideAllSections() {
                instructionsSection.classList.add('hidden');
                studentDataSection.classList.add('hidden');
                testContentSection.classList.add('hidden');
                resultsSummarySection.classList.add('hidden');
            }

            // --- Event Listeners ---

            // Botón "Validar y Continuar" del formulario de datos
            submitDataBtn.addEventListener('click', () => {
                studentName = nameInput.value.trim();
                studentSurname = surnameInput.value.trim();
                studentEmail = emailInput.value.trim();
                studentIdCard = idCardInput.value.trim();

                // Validación básica de campos
                if (!studentName || !studentSurname || !studentEmail || !studentIdCard) {
                    idError.textContent = 'Por favor, completa todos los campos.';
                    return;
                }

                // Validación de formato de email (simple)
                if (!/\S+@\S+\.\S+/.test(studentEmail)) {
                    idError.textContent = 'Por favor, ingresa un correo electrónico válido.';
                    return;
                }

                // Validación de cédula
                if (studentIdCard === unlimitedAccessId || authorizedIds.includes(studentIdCard)) {
                    idError.textContent = ''; // Limpiar mensaje de error si existe
                    hideAllSections();
                    instructionsSection.classList.remove('hidden'); // Mostrar las instrucciones
                } else {
                    idError.textContent = 'Tu cédula no está autorizada para presentar esta prueba. Por favor, verifica el número e inténtalo de nuevo o contacta al administrador.';
                }
            });

            // Botón "Iniciar Prueba" de las instrucciones
            startTestBtn.addEventListener('click', () => {
                hideAllSections();
                testContentSection.classList.remove('hidden'); // Mostrar el contenido de la prueba
                showQuestion(currentQuestionIndex); // Mostrar la primera pregunta
                startTimer(); // Iniciar el temporizador
            });

            // Navegación de preguntas
            document.querySelectorAll('.nav-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const navDirection = event.target.dataset.nav;
                    if (navDirection === 'next') {
                        if (currentQuestionIndex < questionBlocks.length - 1) {
                            currentQuestionIndex++;
                        }
                    } else if (navDirection === 'prev') {
                        if (currentQuestionIndex > 0) {
                            currentQuestionIndex--;
                        }
                    }
                    showQuestion(currentQuestionIndex);
                });
            });

            // Botón "Finalizar Prueba"
            finishTestBtn.addEventListener('click', () => {
                testStatus = 'Completado';
                evaluateAllQuestionsForSubmission(); // Evaluar todas las preguntas para la puntuación y feedback
                submitTest();
            });

            // --- Funciones de evaluación de preguntas (Ahora generan feedback para EmailJS) ---

            function evaluateAllQuestionsForSubmission() {
                score = 0; // Resetear la puntuación antes de recalcular

                // Q1: Días de la semana
                const q1Selected = document.querySelector('input[name="q1"]:checked');
                if (q1Selected && q1Selected.value === correctAnswers.q1.value) {
                    score += questionPoints.q1;
                    feedbackQ1 = `<strong>Pregunta 1 (Días de la semana):</strong><br>¡Excelente! Tu respuesta es correcta. Has seleccionado el orden adecuado de los días de la semana.<br>Respuesta correcta: ${correctAnswers.q1.text}.`;
                } else {
                    const userAnswerText = q1Selected ? q1Selected.labels[0].textContent : 'Ninguna respuesta seleccionada';
                    feedbackQ1 = `<strong>Pregunta 1 (Días de la semana):</strong><br>Tu respuesta: ${userAnswerText}.<br>Parece que necesitas revisar el orden de los días. La secuencia correcta es: ${correctAnswers.q1.text}. ¡Sigue practicando!`;
                }

                // Q2: Oraciones negativas con “To be”
                let q2CorrectCount = 0;
                let q2Details = [];
                document.querySelectorAll('.q2-input').forEach((input, index) => {
                    const userAnswer = input.value.trim();
                    const correctAnswerRegex = correctAnswers.q2[index].regex;
                    const correctAnswerExample = correctAnswers.q2[index].example;
                    if (correctAnswerRegex.test(userAnswer)) {
                        q2CorrectCount++;
                        q2Details.push(`<li>Tu respuesta para "I ... a student": "${userAnswer}" - ¡Correcto!</li>`);
                    } else {
                        q2Details.push(`<li>Tu respuesta para la frase ${index + 1} ("${input.previousSibling.textContent.trim()}..."): "${userAnswer}" - Incorrecto.</li>La forma negativa correcta para esta frase sería: "${correctAnswerExample}". ¡Recuerda las contracciones!`);
                    }
                });
                score += q2CorrectCount * questionPoints.q2;
                feedbackQ2 = `<strong>Pregunta 2 (Oraciones negativas con "To be"):</strong><ul>${q2Details.join('')}</ul>`;

                // Q3: Meses del año
                let q3Selected = Array.from(document.querySelectorAll('input[name="q3"]:checked')).map(cb => cb.value);
                let q3CorrectCount = 0;
                let q3IncorrectSelectionMade = false;
                let q3UserSelectionsText = [];

                document.querySelectorAll('input[name="q3"]').forEach(cb => {
                    if (q3Selected.includes(cb.value)) {
                        q3UserSelectionsText.push(cb.labels[0].textContent.replace(/^\s*\w\)\s*/, '')); // Elimina "a) " etc.
                    }
                });

                q3Selected.forEach(val => {
                    if (correctAnswers.q3.values.includes(val)) {
                        q3CorrectCount++;
                    } else {
                        q3IncorrectSelectionMade = true;
                    }
                });

                if (q3CorrectCount === correctAnswers.q3.values.length && !q3IncorrectSelectionMade) {
                    score += q3CorrectCount * questionPoints.q3;
                    feedbackQ3 = `<strong>Pregunta 3 (Meses del año):</strong><br>¡Excelente! Has identificado todos los meses correctamente.<br>Los meses correctos son: ${correctAnswers.q3.texts.join(', ')}.`;
                } else {
                    const userSelStr = q3UserSelectionsText.length > 0 ? `Tus selecciones: ${q3UserSelectionsText.join(', ')}.` : 'No seleccionaste ninguna opción.';
                    feedbackQ3 = `<strong>Pregunta 3 (Meses del año):</strong><br>${userSelStr}<br>Para esta pregunta, necesitas seleccionar *todos* los meses del año correctos y *solo* ellos. Los meses correctos son: ${correctAnswers.q3.texts.join(', ')}. ¡Un pequeño ajuste y lo lograrás!`;
                }


                // Q4: Números cardinales y ordinales
                let q4Selected = Array.from(document.querySelectorAll('input[name="q4"]:checked')).map(cb => cb.value);
                let q4CorrectCount = 0;
                let q4IncorrectSelectionMade = false;
                let q4UserSelectionsText = [];

                document.querySelectorAll('input[name="q4"]').forEach(cb => {
                    if (q4Selected.includes(cb.value)) {
                        q4UserSelectionsText.push(cb.labels[0].textContent.replace(/^\s*\w\)\s*/, '')); // Elimina "a) " etc.
                    }
                });

                q4Selected.forEach(val => {
                    if (correctAnswers.q4.values.includes(val)) {
                        q4CorrectCount++;
                    } else {
                        q4IncorrectSelectionMade = true;
                    }
                });

                if (q4CorrectCount === correctAnswers.q4.values.length && !q4IncorrectSelectionMade) {
                    score += q4CorrectCount * questionPoints.q4;
                    feedbackQ4 = `<strong>Pregunta 4 (Números cardinales y ordinales):</strong><br>¡Perfecto! Has identificado correctamente todos los números ordinales.<br>Los números ordinales correctos son: ${correctAnswers.q4.texts.join(', ')}.`;
                } else {
                    const userSelStr = q4UserSelectionsText.length > 0 ? `Tus selecciones: ${q4UserSelectionsText.join(', ')}.` : 'No seleccionaste ninguna opción.';
                    feedbackQ4 = `<strong>Pregunta 4 (Números cardinales y ordinales):</strong><br>${userSelStr}<br>Recuerda que los números cardinales (como 'Three', 'Twelve', 'Eighteen') son diferentes de los ordinales. Los números ordinales correctos son: ${correctAnswers.q4.texts.join(', ')}. ¡Sigue practicando la distinción!`;
                }


                // Q5: Interrogativas con “To be”
                let q5CorrectCount = 0;
                let q5Details = [];
                document.querySelectorAll('.q5-input').forEach((input, index) => {
                    const userAnswer = input.value.trim();
                    const correctAnswerRegex = correctAnswers.q5[index].regex;
                    const correctAnswerExample = correctAnswers.q5[index].example;
                    // Obtener la oración original
                    const originalSentenceElement = input.closest('li');
                    const originalSentenceText = originalSentenceElement ? originalSentenceElement.textContent.replace(input.outerHTML, '').trim() : `Oración ${index + 1}`;

                    if (correctAnswerRegex.test(userAnswer)) {
                        q5CorrectCount++;
                        q5Details.push(`<li>Tu respuesta para "${originalSentenceText}": "${userAnswer}" - ¡Magnífico, es correcta!</li>`);
                    } else {
                        q5Details.push(`<li>Tu respuesta para "${originalSentenceText}": "${userAnswer}" - Incorrecta.</li><p style="margin-left:20px;">Para formar preguntas con el verbo 'to be', este debe ir al principio de la oración. La forma correcta sería: "${correctAnswerExample}". ¡Un pequeño ajuste hace una gran diferencia!</p>`);
                    }
                });
                score += q5CorrectCount * questionPoints.q5;
                feedbackQ5 = `<strong>Pregunta 5 (Interrogativas con "To be"):</strong><ul>${q5Details.join('')}</ul>`;

                // Calcular Nivel de Comprensión
                if (score >= 18) {
                    comprehensionLevel = 'Excelente';
                } else if (score >= 14) {
                    comprehensionLevel = 'Bueno';
                } else if (score >= 10) {
                    comprehensionLevel = 'Regular';
                } else {
                    comprehensionLevel = 'Necesita Refuerzo';
                }
            }


            // Enviar la prueba y mostrar resultados
            function submitTest(timeUp = false) {
                clearInterval(timerInterval); // Detener el temporizador

                // Calcular tiempo de respuesta
                const endTime = Date.now();
                const durationSeconds = Math.round((endTime - startTime) / 1000);
                const minutesTaken = Math.floor(durationSeconds / 60);
                const secondsTaken = durationSeconds % 60;
                responseTime = `${minutesTaken} minutos y ${secondsTaken} segundos`;

                // Si la función fue llamada por tiempo agotado, el estado ya fue establecido
                if (!timeUp) {
                    testStatus = 'Completado';
                }

                // Mostrar resumen de resultados
                hideAllSections();
                resultsSummarySection.classList.remove('hidden');
                finalScoreDisplay.textContent = score;

                // Construir el cuerpo del feedback completo para EmailJS
                // ¡IMPORTANTE! Usamos etiquetas HTML dentro de la cadena para que EmailJS las interprete.
                const fullFeedbackEmail = `
                    <p>${feedbackQ1}</p>
                    <p>${feedbackQ2}</p>
                    <p>${feedbackQ3}</p>
                    <p>${feedbackQ4}</p>
                    <p>${feedbackQ5}</p>
                `;

                // Enviar resultados por EmailJS
                const templateParams = {
                    student_id_card: studentIdCard, // Cédula de identidad
                    score: score, // Puntuación final
                    comprehension_level: comprehensionLevel, // Nivel de comprension
                    // student_opinion: studentOpinion, // ELIMINADO: Ya no se envía esta variable
                    test_status: testStatus, // Estado del Test
                    response_time: responseTime, // Tiempo de respuesta del estudiante
                    user_name: studentName, // Para la plantilla, si la necesitas
                    user_surname: studentSurname, // Para la plantilla, si la necesitas
                    user_email: studentEmail, // Para la plantilla, si la necesitas
                    full_feedback: fullFeedbackEmail, // Retroalimentación detallada formateada
                    to_email: 'redaccionseoepub@gmail.com' // Destinatario fijo
                };

                emailjs.send('service_plel29w', 'template_bo27pgn', templateParams)
                    .then(function(response) {
                        console.log('Correo enviado exitosamente!', response.status, response.text);
                    }, function(error) {
                        console.error('Error al enviar el correo:', error);
                        alert('Hubo un error al enviar tus resultados. Por favor, contacta al soporte.');
                    });
            }
        });
    </script>
</body>
</html>
