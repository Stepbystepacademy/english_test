<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Inglés - Step by Step Academy</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Poppins for headings, Open Sans for body -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- MailJS CDN -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        body {
            font-family: 'Open Sans', sans-serif; /* Default body font */
            background-color: #f7f9fc; /* Very light, cool grey background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
            -khtml-user-select: none; /* Konqueror HTML */
            -moz-user-select: none; /* Old versions of Firefox */
            -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently supported by Chrome, Edge, Opera and Firefox */
        }
        .container {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 18px 36px rgba(0, 0, 0, 0.12), 0 14px 24px rgba(0, 0, 0, 0.08); /* More pronounced, modern shadow */
            padding: 2.5rem;
            max-width: 800px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            transition: all 0.3s ease-in-out;
        }
        @media (min-width: 768px) {
            .container {
                padding: 3rem;
            }
        }
        h1, h2, h3 {
            font-family: 'Poppins', sans-serif; /* Poppins for headings */
        }
        .option-button {
            display: block;
            width: 100%;
            padding: 1.1rem 1.5rem;
            margin-bottom: 0.75rem;
            text-align: left;
            border: 2px solid #e0e7ee; /* Lighter subtle border */
            border-radius: 0.75rem;
            background-color: #ffffff; /* White background for options */
            color: #3f4a5a; /* Darker grey text */
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .option-button:hover {
            background-color: #e6f2ff; /* Light blue on hover */
            border-color: #6366f1; /* Indigo border on hover */
            color: #4338ca; /* Darker indigo text */
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.2); /* Indigo shadow on hover */
        }
        .option-button.selected {
            background-color: #c7d2fe; /* Light indigo background when selected */
            border-color: #4338ca; /* Darker indigo border */
            color: #312e81; /* Even darker indigo text */
            box-shadow: 0 2px 8px rgba(67, 56, 202, 0.2);
        }
        .main-button, .send-button {
            padding: 1rem 2rem;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15); /* More prominent shadow */
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .main-button {
            background-image: linear-gradient(to right, #6366f1, #4338ca); /* Indigo gradient */
            color: white;
        }
        .main-button:hover {
            background-image: linear-gradient(to right, #4338ca, #312e81); /* Darker indigo on hover */
            transform: translateY(-4px); /* Slightly more lift */
        }
        .main-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .main-button:disabled, .send-button:disabled {
            background-image: linear-gradient(to right, #cbd5e1, #94a3b8);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .send-button {
             background-image: linear-gradient(to right, #10b981, #059669); /* Emerald gradient */
             color: white;
        }
        .send-button:hover {
            background-image: linear-gradient(to right, #059669, #047857); /* Darker emerald on hover */
            transform: translateY(-4px);
        }
        .send-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e2e8f0;
            border-radius: 9999px;
            height: 12px;
            overflow: hidden;
            margin-top: 1rem;
        }
        .progress-bar {
            height: 100%;
            background-color: #6366f1; /* Indigo progress bar */
            width: 0%;
            border-radius: 9999px;
            transition: width 0.3s ease-out;
        }
        .correction-item {
            background-color: #ffeaea; /* Very light red background */
            border-left: 5px solid #ef4444; /* Standard red border */
            padding: 1.2rem;
            border-radius: 0.75rem;
            margin-bottom: 1.2rem;
            position: relative; /* For explanation positioning */
        }
        .direct-answer-input {
            width: 100%;
            padding: 1.1rem 1.5rem;
            border: 2px solid #e0e7ee;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            color: #3f4a5a;
        }
        .direct-answer-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1; /* Indigo spinner */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #final-thanks-message {
            text-align: center;
            font-size: 2.8rem;
            font-weight: 800; /* Even bolder for Poppins */
            color: #4338ca; /* Darker indigo */
            margin-top: 60px;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 1s ease-out, transform 1s ease-out;
            line-height: 1.3;
            position: fixed; /* Keep it centered even if main app is hidden */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000; /* Ensure it's on top */
            background-color: #ffffff; /* Add background for visibility */
            padding: 3rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
        }
        #final-thanks-message.show {
            opacity: 1;
            transform: translate(-50%, -50%);
        }
        /* Styles for topic list */
        #topics-list-container {
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background-color: #f0f7ff; /* Very light blue background */
            border-radius: 1rem;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        #topics-list-container h3 {
            color: #312e81; /* Dark indigo for topic title */
            font-size: 1.8rem;
            margin-bottom: 1rem;
            text-align: left;
        }
        #topics-list {
            list-style: none; /* Remove default bullet points */
            padding-left: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem; /* Space between topics */
        }
        #topics-list li {
            background-color: #dbeafe; /* Lighter blue for topic tags */
            color: #4338ca; /* Indigo text for topics */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .timer-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3f4a5a;
            background-color: #e6f2ff;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            margin-left: auto; /* Push to right */
            min-width: 120px;
            text-align: center;
        }
        .timer-display.low-time {
            color: #dc2626; /* Red for low time */
            background-color: #fee2e2;
        }
    </style>
</head>
<body>
    <div id="quiz-app" class="container">
        <!-- Header - Now controlled by JavaScript to hide during quiz -->
        <div id="main-header" class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-blue-800 mb-2">Step by Step Academy</h1>
            <p class="text-lg text-gray-600 italic">"Tu camino al éxito en inglés, paso a paso."</p>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">¡Bienvenido a tu primera prueba de inglés!</h2>
            <p class="text-gray-700 font-bold mb-6">Cada respuesta correcta vale 0.5 puntos. Puntuación máxima: 20 puntos.</p>
            <p class="text-gray-700 font-bold text-xl mb-6">Tiempo límite: <span class="text-blue-600 font-extrabold">120 minutos</span></p>
            
            <div id="topics-list-container">
                <h3 class="text-xl font-semibold">Temas a Evaluar:</h3>
                <ul id="topics-list">
                    <!-- Topics will be dynamically loaded here by JavaScript -->
                </ul>
            </div>

            <div class="mb-4 space-y-3">
                <input type="text" id="user-name" placeholder="Tu Nombre" class="direct-answer-input" required>
                <input type="text" id="user-surname" placeholder="Tu Apellido" class="direct-answer-input" required>
                <input type="email" id="user-email" placeholder="Tu Correo Electrónico" class="direct-answer-input" required>
                <input type="text" id="user-id-card" placeholder="Tu Cédula de Identidad" class="direct-answer-input" required>
            </div>
            
            <div class="flex justify-center mt-6">
                <button id="start-quiz-button" class="main-button" disabled>Comenzar Prueba</button>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <span id="question-counter" class="text-gray-600 font-medium text-lg"></span>
                <div id="timer-display" class="timer-display">00:00</div>
            </div>
            <div class="progress-bar-container mb-6"><div id="progress-bar" class="progress-bar"></div></div>
            <h2 id="question-text" class="text-2xl font-semibold text-gray-800 mb-6"></h2>
            <div id="options-container" class="flex flex-col gap-3"></div>
            <button id="next-button" class="main-button mt-8 w-full" disabled>Siguiente</button>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="hidden text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">¡Prueba Finalizada!</h2>
            <p class="text-gray-700 text-xl mb-6">Tu puntuación final es: <span id="final-score" class="font-bold text-blue-600 text-3xl"></span> / 20</p>
            <div id="feedback-message" class="text-lg mb-4 text-gray-600"></div>
            <div id="comprehension-level" class="text-2xl font-bold text-gray-800 mb-6"></div>
            
            <!-- Incorrect Answers Section -->
            <div id="incorrect-answers-section" class="text-left mt-8 p-4 bg-gray-50 rounded-lg shadow-inner">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">Repaso de Preguntas Incorrectas:</h3>
                <div id="incorrect-answers-list">
                    <!-- Incorrect questions will be listed here without "Explicar" button -->
                </div>
            </div>

            <!-- Send Email Button -->
            <button id="send-delia-email-button" class="send-button mt-8 w-full">
                <i class="fas fa-paper-plane"></i> Enviar Resultados y Cerrar
            </button>
            <div id="email-status-message" class="text-sm mt-2 text-gray-600 hidden"></div>
        </div>
    </div>

    <!-- Final Thanks Message - Shown after successful email send and app hides -->
    <div id="final-thanks-message" class="hidden">
        ¡Gracias por completar la prueba!
    </div>

    <script>
        // --- START OF QUIZ DATA ---
        // Original 20 questions
        const originalQuestions = [
            // Saludos (Greetings)
            { question: "Completa el saludo formal: 'Good ___.'", options: ["night", "bye", "morning", "later"], answer: "morning", topic: "Saludos", type: "multiple-choice" },
            // MODIFIED: Old: { question: "Elige la respuesta apropiada a 'How are you?':", options: ["I'm fine, thank you.", "I'm sad.", "I'm busy.", "I'm tired."], answer: "I'm fine, thank you.", topic: "Saludos", type: "multiple-choice" },
            { question: "Cuando alguien dice 'Nice to meet you', ¿cuál es una respuesta común?", options: ["You're welcome.", "Nice to meet you too.", "Goodbye.", "See you later."], answer: "Nice to meet you too.", topic: "Saludos", type: "multiple-choice" },

            // Sustantivos Singular y Plural
            { question: "Selecciona la forma plural correcta de 'child'.", options: ["childs", "children", "childen", "child's"], answer: "children", topic: "Sustantivos Singular y Plural", type: "multiple-choice" },

            // Días de la semana (Days of the Week)
            { question: "El día después de 'Tuesday' es ___.", options: ["Thursday", "Monday", "Wednesday", "Sunday"], answer: "Wednesday", topic: "Días de la semana", type: "multiple-choice" },
            { question: "Escribe cómo se dice 'Sábado' en inglés:", answer: "Saturday", topic: "Días de la semana", type: "direct-answer" },

            // Meses del año (Months of the Year)
            { question: "¿Cuál es el quinto mes del año?", options: ["April", "June", "May", "July"], answer: "May", topic: "Meses del año", type: "multiple-choice" },
            { question: "Escribe el mes que viene después de 'October':", answer: "November", topic: "Meses del año", type: "direct-answer" },

            // Números Cardinales (Cardinal Numbers)
            { question: "¿Cómo se escribe el número '15' en inglés?", options: ["Fifteen", "Fiveteen", "Fiftin", "Fithteen"], answer: "Fifteen", topic: "Números Cardinales", type: "multiple-choice" },
            { question: "El número 200 se escribe 'Two ___'. Completa la palabra faltante:", options: ["thousands", "millions", "hundred", "hundredths"], answer: "hundred", topic: "Números Cardinales", type: "multiple-choice" },
            // MODIFIED: Old: { question: "Si alguien tiene 'ten years old', ¿qué número representa 'ten'?", answer: "10", topic: "Números Cardinales", type: "direct-answer" },
            { question: "Si alguien tiene 'ten years old', ¿qué número representa 'ten'?", answer: ["10", "diez"], topic: "Números Cardinales", type: "direct-answer" },

            // Números Ordinales (Ordinal Numbers)
            { question: "¿Cuál es la forma ordinal de '1'?", options: ["first", "one", "oneth", "firsth"], answer: "first", topic: "Números Ordinales", type: "multiple-choice" },
            { question: "Escribe el número ordinal '2nd':", answer: "second", topic: "Números Ordinales", type: "direct-answer" },
            { question: "Completa la oración: 'This is my ___ English lesson.' (Refiriéndose a la 5ta lección)", options: ["fiveth", "five", "fifth", "fith"], answer: "fifth", topic: "Números Ordinales", type: "multiple-choice" },

            // Verbo "To Be"
            { question: "Completa la oración con la forma correcta de 'to be': 'They ___ happy to be here.'", options: ["is", "am", "are", "be"], answer: "are", topic: "Verbo To Be", type: "multiple-choice" },
            { question: "Completa la oración con la forma correcta de 'to be': 'My mother ___ a doctor.'", answer: "is", topic: "Verbo To Be", type: "direct-answer" },

            // La Familia (The Family)
            { question: "El padre de tu esposa es tu '___'.", options: ["brother in law", "father in law", "step dad", "godfather"], answer: "father in law", topic: "La Familia", type: "multiple-choice" },
            // MODIFIED: Old: { question: "¿Cómo te refieres a una hija adoptiva en inglés?", answer: "stepdaughter", topic: "La Familia", type: "direct-answer" },
            { question: "¿Cómo se dice 'hijo' en inglés?", answer: "son", topic: "La Familia", type: "direct-answer" },
            
            // Partes del Cuerpo (Body Parts)
            { question: "La parte del cuerpo que usas para oír es tu '___'.", options: ["nose", "mouth", "ear", "eye"], answer: "ear", topic: "Partes del Cuerpo", type: "multiple-choice" },

            // La Hora (The Time)
            { question: "Completa la oración: 'When it's 3:30, we say 'Half ___ three'.", options: ["to", "past", "for", "at"], answer: "past", topic: "La Hora", type: "multiple-choice" },

            // Uso de "A" y "An"
            { question: "Completa la oración: 'She is eating ___ apple.'", options: ["a", "an", "the", "some"], answer: "an", topic: "A y An", type: "multiple-choice" }
        ];

        // 20 New questions to make a total of 40
        const newQuestions = [
            // Saludos (Greetings)
            { question: "¿Cómo se dice 'Buenas noches' (al despedirse) en inglés?", answer: "Good night", topic: "Saludos", type: "direct-answer" },
            { question: "Elige la respuesta apropiada a 'Hello':", options: ["Hi", "Goodbye", "See you", "How do you do?"], answer: "Hi", topic: "Saludos", type: "multiple-choice" }, // New question

            // Sustantivos Singular y Plural
            { question: "Selecciona la forma plural correcta de 'mouse'.", options: ["mouses", "mice", "mousees", "mouces"], answer: "mice", topic: "Sustantivos Singular y Plural", type: "multiple-choice" },
            { question: "Escribe la forma singular de 'teeth':", answer: "tooth", topic: "Sustantivos Singular y Plural", type: "direct-answer" },
            { question: "El plural de 'person' es '___'.", options: ["persons", "peoples", "people", "persones"], answer: "people", topic: "Sustantivos Singular y Plural", type: "multiple-choice" },
            { question: "La forma plural de 'man' es '___'.", options: ["mans", "men", "menn", "man's"], answer: "men", topic: "Sustantivos Singular y Plural", type: "multiple-choice" },

            // Días de la semana (Days of the Week)
            { question: "El día antes de 'Friday' es ___.", options: ["Wednesday", "Tuesday", "Thursday", "Saturday"], answer: "Thursday", topic: "Días de la semana", type: "multiple-choice" },
            { question: "Escribe el día de la semana que es el primero en inglés:", answer: "Sunday", topic: "Días de la semana", type: "direct-answer" },

            // Meses del año (Months of the Year)
            { question: "¿Cuál es el primer mes del año?", options: ["February", "March", "January", "December"], answer: "January", topic: "Meses del año", type: "multiple-choice" },
            { question: "Escribe el mes de 'Navidad' en inglés:", answer: "December", topic: "Meses del año", type: "direct-answer" },

            // Números Cardinales (Cardinal Numbers)
            { question: "¿Cómo se escribe el número '30' en inglés?", options: ["Thirteen", "Thirty", "Twinty", "Thurty"], answer: "Thirty", topic: "Números Cardinales", type: "multiple-choice" },
            { question: "Escribe el número '1000' en inglés:", answer: "one thousand", topic: "Números Cardinales", type: "direct-answer" },
            { question: "¿Cómo se escribe el número '12' en inglés?", options: ["Eleven", "Twelv", "Twelve", "Twelwe"], answer: "Twelve", topic: "Números Cardinales", type: "multiple-choice" },
            { question: "El número '50' en inglés es '___'.", answer: "fifty", topic: "Números Cardinales", type: "direct-answer" },

            // Números Ordinales (Ordinal Numbers)
            { question: "¿Cuál es la forma ordinal de '3'?", options: ["threeth", "third", "thirth", "three"], answer: "third", topic: "Números Ordinales", type: "multiple-choice" },
            { question: "Escribe el número ordinal '4th':", answer: "fourth", topic: "Números Ordinales", type: "direct-answer" },
            { question: "¿Cuál es la forma ordinal de '20'?", options: ["twentieth", "twentyth", "twentith", "twentiet"], answer: "twentieth", topic: "Números Ordinales", type: "multiple-choice" },

            // Verbo "To Be"
            { question: "Completa la oración: 'She ___ a student.'", answer: "is", topic: "Verbo To Be", type: "direct-answer" },
            { question: "Completa la oración: 'I ___ from Venezuela.'", answer: "am", topic: "Verbo To Be", type: "direct-answer" },
            { question: "Completa la oración: 'He ___ my brother.'", answer: "is", topic: "Verbo To Be", type: "direct-answer" },

            // La Familia (The Family)
            { question: "La hermana de tu madre es tu '___'.", options: ["niece", "cousin", "aunt", "sister-in-law"], answer: "aunt", topic: "La Familia", type: "multiple-choice" },
            { question: "¿Cómo se dice 'niña' en inglés?", answer: "girl", topic: "La Familia", type: "direct-answer" }, // New question

            // Partes del Cuerpo (Body Parts)
            { question: "La parte del cuerpo que usas para caminar es tu '___'.", options: ["hand", "arm", "foot", "leg"], answer: "foot", topic: "Partes del Cuerpo", type: "multiple-choice" },
            { question: "Escribe cómo se dice 'mano' en inglés:", answer: "hand", topic: "Partes del Cuerpo", type: "direct-answer" },

            // La Hora (The Time)
            { question: "Si son las 6:00 en punto, decimos 'Six o'___'.", answer: "clock", topic: "La Hora", type: "direct-answer" },

            // Uso de "A" y "An"
            { question: "Completa la oración: 'He has ___ interesting book.'", options: ["a", "an", "the", "some"], answer: "an", topic: "A y An", type: "multiple-choice" },
            { question: "Completa la oración: 'I saw ___ dog in the park.'", options: ["a", "an", "the", "some"], answer: "a", topic: "A y An", type: "multiple-choice" },
            { question: "Completa la oración: 'It is ___ honor to meet you.'", options: ["a", "an", "the", "some"], answer: "an", topic: "A y An", type: "multiple-choice" }
        ];

        // Combine original and new questions
        // Note: The total number of questions is 40, as originalQuestions (20) + newQuestions (20)
        // The `shuffledQuestions.slice(0, MAX_QUESTIONS)` ensures we only take 40 questions if `allQuestions` is larger.
        // It's good practice to have more questions in `allQuestions` than `MAX_QUESTIONS` for better randomization.
        // In this case, allQuestions now has exactly 40 unique questions.
        const allQuestions = [...originalQuestions, ...newQuestions];


        // --- END OF QUIZ DATA ---

        // --- GLOBAL QUIZ VARIABLES ---
        let shuffledQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let userAnswers = [];
        let incorrectQuestionsData = [];
        let selectedOptionElement = null;
        let directAnswerInput = null;
        let userName = '', userSurname = '', userEmail = '', userIdCard = ''; 
        let timerInterval; // Variable to hold the timer interval
        let remainingTime; // Time in seconds
        let quizSubmittedByTimeOut = false; // Flag to indicate if quiz was submitted due to time out

        // --- DOM ELEMENTS ---
        const quizAppContainer = document.getElementById('quiz-app');
        const mainHeader = document.getElementById('main-header'); // Get the main header element
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        const startQuizButton = document.getElementById('start-quiz-button');
        const userNameInput = document.getElementById('user-name');
        const userSurnameInput = document.getElementById('user-surname');
        const userEmailInput = document.getElementById('user-email');
        const userIdCardInput = document.getElementById('user-id-card');
        const questionCounter = document.getElementById('question-counter');
        const progressBar = document.getElementById('progress-bar');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const nextButton = document.getElementById('next-button');
        const finalScore = document.getElementById('final-score');
        const feedbackMessage = document.getElementById('feedback-message');
        const comprehensionLevel = document.getElementById('comprehension-level');
        const incorrectAnswersSection = document.getElementById('incorrect-answers-section');
        const incorrectAnswersList = document.getElementById('incorrect-answers-list');
        const sendDeliaEmailButton = document.getElementById('send-delia-email-button');
        const emailStatusMessage = document.getElementById('email-status-message');
        const finalThanksMessage = document.getElementById('final-thanks-message');
        const topicsListElement = document.getElementById('topics-list');
        const timerDisplay = document.getElementById('timer-display'); // New timer display element

        // --- CONSTANTS ---
        const MAX_QUESTIONS = 40; // Total questions changed to 40
        const POINTS_PER_QUESTION = 0.5; // Points per question changed to 0.5
        const QUIZ_DURATION_MINUTES = 120; // Duration changed to 120 minutes
        const MAX_SCORE = MAX_QUESTIONS * POINTS_PER_QUESTION; // Will be 40 * 0.5 = 20
        const QUIZ_COMPLETED_PREFIX = 'stepByStepQuizCompleted_'; 
        const QUIZ_DATA_STORAGE_KEY = 'stepByStepQuizData'; 

        const ALLOWED_IDS = ['10182241', '26774670', '26774671', '10182242', '30521171', '30521172', '790622', '7920623', '7920624'];
        const UNLIMITED_ACCESS_ID = '27774669'; // Cédula con acceso ilimitado

        // MailJS Configuration
        const SERVICE_ID = 'service_mbogde3';
        const TEMPLATE_ID = 'template_99lgrsf';
        const PUBLIC_KEY = '7FE4lqcCZ69cThSp_';
        const DELIA_EMAIL = 'redaccionseoepub@gmail.com';

        // Initialize MailJS
        emailjs.init(PUBLIC_KEY);

        // --- GENERAL UI & NAVIGATION ---
        function showScreen(screenId) {
            // Hide all main screens first
            startScreen.classList.add('hidden');
            quizScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            finalThanksMessage.classList.add('hidden'); // Ensure thank you message is hidden

            // Show the requested screen
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
                quizAppContainer.classList.remove('hidden'); // Ensure main app container is visible
            } else {
                console.error(`Error: Screen with ID '${screenId}' not found.`);
                quizAppContainer.classList.add('hidden'); // Hide main app if target screen is invalid
            }
            
            // Control visibility of the main header
            if (screenId === 'quiz-screen') {
                mainHeader.classList.add('hidden'); // Hide header during quiz
            } else {
                mainHeader.classList.remove('hidden'); // Show header on start/results screens
            }

            // Specific actions when showing start screen
            if (screenId === 'start-screen') {
                 // Reset input fields
                userNameInput.value = '';
                userSurnameInput.value = '';
                userEmailInput.value = '';
                userIdCardInput.value = '';
                checkInputsAndEnableStartButton(); // Re-evaluate button state
            }
        }

        // --- TIMER LOGIC ---
        function startTimer() {
            remainingTime = QUIZ_DURATION_MINUTES * 60; // Convert minutes to seconds
            updateTimerDisplay(); // Initial display

            timerInterval = setInterval(() => {
                remainingTime--;
                updateTimerDisplay();

                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    autoSubmitQuiz();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timerDisplay.textContent = formattedTime;

            if (remainingTime <= 60) { // Less than 1 minute remaining
                timerDisplay.classList.add('low-time');
            } else {
                timerDisplay.classList.remove('low-time');
            }
        }

        function autoSubmitQuiz() {
            quizSubmittedByTimeOut = true; // Set flag
            // Disable all options and next button
            optionsContainer.querySelectorAll('button').forEach(button => button.disabled = true);
            if (directAnswerInput) directAnswerInput.disabled = true;
            nextButton.disabled = true;
            
            displayMessageBox("¡Tiempo Agotado!", "El tiempo para completar la prueba ha terminado. Tus respuestas se enviarán automáticamente.");
            submitQuiz(); // Submit the quiz
        }

        // --- QUIZ LOGIC ---

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        /**
         * Helper function to check if a user's answer is correct,
         * supporting multiple correct answers for direct input types.
         * @param {string} userAnswer - The answer provided by the user.
         * @param {string|string[]} correctAnswer - The correct answer(s). Can be a single string or an array of strings.
         * @returns {boolean} True if the user's answer is correct, false otherwise.
         */
        function isAnswerCorrect(userAnswer, correctAnswer) {
            const normalizedUserAnswer = (userAnswer || '').toLowerCase().trim();
            if (Array.isArray(correctAnswer)) {
                return correctAnswer.map(a => a.toLowerCase().trim()).includes(normalizedUserAnswer);
            } else {
                return normalizedUserAnswer === correctAnswer.toLowerCase().trim();
            }
        }


        function checkInputsAndEnableStartButton() {
            const isNameValid = userNameInput.value.trim() !== '';
            const isSurnameValid = userSurnameInput.value.trim() !== '';
            const isEmailValid = userEmailInput.value.trim() !== '' && userEmailInput.checkValidity();
            const isIdCardValid = ALLOWED_IDS.includes(userIdCardInput.value.trim());

            startQuizButton.disabled = !(isNameValid && isSurnameValid && isEmailValid && isIdCardValid);
        }

        function displayTopics() {
            const uniqueTopics = new Set(allQuestions.map(q => q.topic));
            topicsListElement.innerHTML = '';
            uniqueTopics.forEach(topic => {
                const listItem = document.createElement('li');
                listItem.textContent = topic;
                topicsListElement.appendChild(listItem);
            });
        }

        function startQuiz() {
            userName = userNameInput.value.trim();
            userSurname = userSurnameInput.value.trim();
            userEmail = userEmailInput.value.trim();
            userIdCard = userIdCardInput.value.trim();

            const isNameValid = userName !== '';
            const isSurnameValid = userSurname !== '';
            const isEmailValid = userEmail !== '' && userEmailInput.checkValidity();
            const isIdCardValid = ALLOWED_IDS.includes(userIdCard);

            if (!isNameValid || !isSurnameValid || !isEmailValid || !isIdCardValid) {
                displayMessageBox("Error de Inicio", "Por favor, completa todos los campos correctamente y asegúrate de que tu cédula esté registrada.");
                return;
            }

            // Check if THIS specific ID card has already completed the quiz, unless it's the unlimited access ID
            if (userIdCard !== UNLIMITED_ACCESS_ID) {
                const quizCompletedForThisID = localStorage.getItem(QUIZ_COMPLETED_PREFIX + userIdCard) === 'true';
                if (quizCompletedForThisID) {
                    displayMessageBox("Prueba Ya Completada", `La cédula ${userIdCard} ya ha presentado esta prueba. No se permite un nuevo intento. La aplicación se cerrará automáticamente.`);
                    setTimeout(() => {
                        quizAppContainer.classList.add('hidden');
                        finalThanksMessage.classList.remove('hidden');
                        finalThanksMessage.classList.add('show');
                    }, 1000);
                    return;
                }
            } else {
                console.log(`Cédula ${UNLIMITED_ACCESS_ID} detectada: Acceso ilimitado, omitiendo la verificación de finalización.`);
            }

            showScreen('quiz-screen');

            currentQuestionIndex = 0;
            score = 0;
            userAnswers = new Array(MAX_QUESTIONS).fill(null); // Ensure userAnswers array matches MAX_QUESTIONS
            incorrectQuestionsData = [];
            quizSubmittedByTimeOut = false; // Reset flag for new test session

            emailStatusMessage.classList.add('hidden');
            emailStatusMessage.textContent = '';
            
            // Shuffle questions and slice to MAX_QUESTIONS
            let tempQuestions = [...allQuestions];
            shuffleArray(tempQuestions);
            shuffledQuestions = tempQuestions.slice(0, MAX_QUESTIONS);

            // Start the timer when the quiz officially begins
            startTimer();
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQuestionIndex >= shuffledQuestions.length) {
                stopTimer(); // Stop timer when all questions are loaded/answered
                submitQuiz(); // Move to results screen
                return;
            }

            const question = shuffledQuestions[currentQuestionIndex];
            questionText.textContent = question.question;
            optionsContainer.innerHTML = '';
            selectedOptionElement = null;
            directAnswerInput = null;

            if (question.type === "multiple-choice" || question.type === "true-false") {
                const optionsToDisplay = question.type === "true-false" ? ["True", "False"] : [...question.options];
                optionsToDisplay.forEach(optionText => {
                    const button = document.createElement('button');
                    button.textContent = optionText;
                    button.classList.add('option-button');
                    button.addEventListener('click', () => selectAnswer(optionText, button));
                    optionsContainer.appendChild(button);
                    // Pre-select if there's a saved answer (e.g., after time-out and reviewing)
                    if (userAnswers[currentQuestionIndex] === optionText) {
                        button.classList.add('selected');
                        selectedOptionElement = button;
                    }
                });
            } else if (question.type === "direct-answer") {
                const input = document.createElement('input');
                input.type = 'text';
                input.classList.add('direct-answer-input');
                input.placeholder = 'Escribe tu respuesta aquí...';
                input.value = userAnswers[currentQuestionIndex] || ''; // Populate with saved answer if any
                input.addEventListener('input', (event) => {
                    userAnswers[currentQuestionIndex] = event.target.value;
                    nextButton.disabled = event.target.value.trim() === '';
                });
                optionsContainer.appendChild(input);
                directAnswerInput = input;
            }

            // Disable next button if no answer selected for current question, or if it's a direct answer and input is empty
            const currentAnswer = userAnswers[currentQuestionIndex];
            if (question.type === "direct-answer") {
                nextButton.disabled = (currentAnswer || '').trim() === '';
            } else {
                nextButton.disabled = currentAnswer === null;
            }

            nextButton.textContent = (currentQuestionIndex === shuffledQuestions.length - 1) ? 'Finalizar Prueba' : 'Siguiente';
            updateQuestionCounter();
            updateProgress();
        }

        function selectAnswer(optionValue, buttonElement) {
            if (selectedOptionElement) selectedOptionElement.classList.remove('selected');
            selectedOptionElement = buttonElement;
            selectedOptionElement.classList.add('selected');
            userAnswers[currentQuestionIndex] = optionValue;
            nextButton.disabled = false;
        }

        function nextQuestion() {
            // Before moving to next question, save the current answer if it's a direct answer input
            if (shuffledQuestions[currentQuestionIndex].type === "direct-answer") {
                userAnswers[currentQuestionIndex] = directAnswerInput ? directAnswerInput.value.trim() : '';
            }
            currentQuestionIndex++;
            loadQuestion();
        }

        function updateProgress() {
            progressBar.style.width = `${((currentQuestionIndex) / shuffledQuestions.length) * 100}%`;
        }

        function updateQuestionCounter() {
            questionCounter.textContent = `Pregunta ${currentQuestionIndex + 1} de ${shuffledQuestions.length}`;
        }

        function submitQuiz() {
            stopTimer(); // Ensure timer is stopped if quiz is submitted manually
            // Calculate final score and incorrect questions data
            score = 0;
            incorrectQuestionsData = [];
            userAnswers.forEach((userAnswer, index) => {
                // Ensure to check against the actual question in shuffledQuestions, as userAnswers can be sparse.
                const q = shuffledQuestions[index];
                if (q) { // Check if question exists (relevant if userAnswers was pre-filled and some questions weren't loaded)
                    // Use the new isAnswerCorrect helper function
                    const isCorrect = isAnswerCorrect(userAnswer, q.answer);
                    if (isCorrect) {
                        score += POINTS_PER_QUESTION;
                    } else {
                        incorrectQuestionsData.push({ ...q, userAnswer, index: index + 1 });
                    }
                }
            });

            // Save basic quiz data to localStorage
            const quizDataToPersist = {
                userName: userName,
                userSurname: userSurname,
                userEmail: userEmail,
                userIdCard: userIdCard,
                finalScore: score,
                incorrectQuestions: incorrectQuestionsData,
                submittedByTimeOut: quizSubmittedByTimeOut // Save time out status
            };
            localStorage.setItem(QUIZ_DATA_STORAGE_KEY, JSON.stringify(quizDataToPersist));

            showScreen('results-screen');
            finalScore.textContent = score.toFixed(0);
            displayResultsFeedback();
            displayIncorrectAnswers();
            
            // Enable the send button
            sendDeliaEmailButton.disabled = false;
        }

        function displayResultsFeedback() {
            let levelMessage = "", levelColor = "", feedback = "";
            if (score >= 17) {
                levelMessage = "COMPRENSIÓN NIVEL ALTO"; levelColor = "text-green-700"; feedback = "¡Impresionante! Has dominado los conceptos.";
            } else if (score >= 13) {
                levelMessage = "COMPRENSIÓN NIVEL MEDIO"; levelColor = "text-yellow-600"; feedback = "¡Excelente! Estás en muy buen camino.";
            } else if (score >= 9) {
                levelMessage = "COMPRENSIÓN NIVEL BAJO"; levelColor = "text-orange-500"; feedback = "Buen trabajo. Sigue practicando para mejorar.";
            } else {
                levelMessage = "NECESITA REFORZAR"; levelColor = "text-red-600"; feedback = "No te rindas. ¡Repasa y lo lograrás!";
            }
            comprehensionLevel.textContent = levelMessage;
            comprehensionLevel.className = `text-2xl font-bold mb-6 ${levelColor}`;
            feedbackMessage.textContent = feedback;
        }

        function displayIncorrectAnswers() {
            incorrectAnswersList.innerHTML = '';
            if (incorrectQuestionsData.length > 0) {
                incorrectAnswersSection.classList.remove('hidden');
                incorrectQuestionsData.forEach(item => {
                    const div = document.createElement('div');
                    div.classList.add('correction-item');
                    // For display, show all accepted answers if it was an array
                    const correctAnswerDisplay = Array.isArray(item.answer) ? item.answer.join(' / ') : item.answer;
                    div.innerHTML = `
                        <p class="font-medium"><strong>Pregunta ${item.index}:</strong> ${item.question}</p>
                        <p>Tu respuesta: <span class="text-red-600">${item.userAnswer || "No respondida"}</span></p>
                        <p>Respuesta correcta: <span class="text-green-600">${correctAnswerDisplay}</span></p>`;
                    incorrectAnswersList.appendChild(div);
                });
            } else {
                incorrectAnswersSection.classList.add('hidden');
            }
        }

        // --- MAILJS INTEGRATION ---
        async function sendQuizResultsByEmail(userData, quizScore, incorrectAnswersArray, submittedByTimeOut, sendButton, statusMessageElement, finalAction = null) {
            sendButton.disabled = true;
            sendButton.innerHTML = `<div class="loading-spinner"></div> Enviando...`;
            statusMessageElement.classList.remove('hidden');
            statusMessageElement.textContent = 'Enviando resultados por correo...';
            statusMessageElement.style.color = '#64748b';

            let incorrectAnswersHtml = "";
            if (incorrectAnswersArray && incorrectAnswersArray.length > 0) {
                incorrectAnswersHtml += '<h3 style="font-size: 1.25rem; font-weight: 600; color: #1f2937;">Preguntas Incorrectas:</h3><ul style="list-style-type: none; padding: 0;">';
                incorrectAnswersArray.forEach(item => {
                    // For email, display all accepted answers if it was an array
                    const correctAnswerForEmail = Array.isArray(item.answer) ? item.answer.join(' / ') : item.answer;
                    incorrectAnswersHtml += `<li style="margin-bottom: 0.5rem; padding: 0.75rem; border: 1px solid #fed7aa; border-radius: 0.5rem; background-color: #fff7ed;">`;
                    incorrectAnswersHtml += `<strong>Pregunta ${item.index}:</strong> ${item.question}<br>`;
                    incorrectAnswersHtml += `Tu respuesta: <span style="color: #dc2626; font-weight: 500;">${item.userAnswer || "No respondida"}</span><br>`;
                    incorrectAnswersHtml += `Respuesta correcta: <span style="color: #16a34a; font-weight: 500;">${correctAnswerForEmail}</span></li>`;
                });
                incorrectAnswersHtml += "</ul>";
            } else {
                incorrectAnswersHtml = '<p style="font-weight: 500; color: #16a34a;">¡Felicidades! No tuviste preguntas incorrectas. ¡Excelente trabajo!</p>';
            }

            const timeStatusText = submittedByTimeOut ? 'El test se envió automáticamente al agotarse el tiempo.' : 'El test se completó a tiempo.';

            const templateParams = {
                to_name: 'Delia',
                to_email: DELIA_EMAIL,
                user_name: userData.userName,
                user_surname: userData.userSurname,
                user_email: userData.userEmail,
                user_id_card: userData.userIdCard,
                final_score: quizScore,
                comprehension_level: comprehensionLevel.textContent,
                feedback_message: feedbackMessage.textContent,
                time_status: timeStatusText, // New parameter for time status
                incorrect_answers_html: incorrectAnswersHtml
            };

            try {
                await emailjs.send(SERVICE_ID, TEMPLATE_ID, templateParams);
                statusMessageElement.textContent = 'Resultados enviados con éxito a Delia.';
                statusMessageElement.style.color = '#16a34a';
                sendButton.innerHTML = `<i class="fas fa-check"></i> Resultados Enviados`;
                sendButton.disabled = true;

                // Only mark the quiz as completed for non-unlimited access IDs
                if (userData.userIdCard !== UNLIMITED_ACCESS_ID) {
                    localStorage.setItem(QUIZ_COMPLETED_PREFIX + userData.userIdCard, 'true'); 
                    console.log(`Quiz completado para la cédula ${userData.userIdCard} y email enviado marcado en localStorage.`);
                } else {
                    console.log(`Cédula ${UNLIMITED_ACCESS_ID}: Acceso ilimitado, no se marca como completada en localStorage.`);
                }

                if (finalAction === 'close') {
                    setTimeout(() => {
                        quizAppContainer.classList.add('hidden');
                        finalThanksMessage.classList.remove('hidden');
                        finalThanksMessage.classList.add('show');
                    }, 1000); 
                }
                
            } catch (error) {
                console.error('Error al enviar el correo:', error);
                statusMessageElement.textContent = 'Error al enviar los resultados. Inténtalo de nuevo más tarde.';
                statusMessageElement.style.color = '#dc2626';
                sendButton.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error al Enviar`;
                sendButton.disabled = false;
            }
        }

        // --- CUSTOM MESSAGE BOX (replacing alert()) ---
        function displayMessageBox(title, message) {
            const messageBoxContainer = document.createElement('div');
            messageBoxContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.6);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            const messageBox = document.createElement('div');
            messageBox.style.cssText = `
                background-color: #ffffff;
                padding: 2.5rem;
                border-radius: 1rem;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                max-width: 450px;
                width: 90%;
                text-align: center;
                font-family: 'Open Sans', sans-serif;
            `;

            const messageTitle = document.createElement('h3');
            messageTitle.textContent = title;
            messageTitle.style.cssText = `
                font-family: 'Poppins', sans-serif;
                font-size: 1.8rem;
                color: #4338ca;
                margin-bottom: 1rem;
            `;

            const messageText = document.createElement('p');
            messageText.textContent = message;
            messageText.style.cssText = `
                font-size: 1.1rem;
                color: #3f4a5a;
                margin-bottom: 1.5rem;
            `;

            const closeButton = document.createElement('button');
            closeButton.textContent = 'Entendido';
            closeButton.style.cssText = `
                background-image: linear-gradient(to right, #6366f1, #4338ca);
                color: white;
                padding: 0.8rem 1.5rem;
                font-size: 1rem;
                font-weight: 600;
                border-radius: 0.5rem;
                border: none;
                cursor: pointer;
                transition: all 0.2s ease;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            `;
            closeButton.onmouseover = () => closeButton.style.backgroundImage = 'linear-gradient(to right, #4338ca, #312e81)';
            closeButton.onmouseout = () => closeButton.style.backgroundImage = 'linear-gradient(to right, #6366f1, #4338ca)';
            closeButton.onclick = () => document.body.removeChild(messageBoxContainer);

            messageBox.appendChild(messageTitle);
            messageBox.appendChild(messageText);
            messageBox.appendChild(closeButton);
            messageBoxContainer.appendChild(messageBox);
            document.body.appendChild(messageBoxContainer);
        }

        // --- EVENT LISTENERS ---
        userNameInput.addEventListener('input', checkInputsAndEnableStartButton);
        userSurnameInput.addEventListener('input', checkInputsAndEnableStartButton);
        userEmailInput.addEventListener('input', checkInputsAndEnableStartButton);
        userIdCardInput.addEventListener('input', checkInputsAndEnableStartButton);

        startQuizButton.addEventListener('click', startQuiz);
        nextButton.addEventListener('click', nextQuestion);
        
        // Listener for the "Enviar Resultados y Cerrar" button on the results screen
        sendDeliaEmailButton.addEventListener('click', () => {
            const persistedQuizData = JSON.parse(localStorage.getItem(QUIZ_DATA_STORAGE_KEY));
            if (persistedQuizData) {
                // Use the data saved right after the quiz part, including submittedByTimeOut flag
                sendQuizResultsByEmail({
                    userName: persistedQuizData.userName,
                    userSurname: persistedQuizData.userSurname,
                    userEmail: persistedQuizData.userEmail,
                    userIdCard: persistedQuizData.userIdCard
                }, persistedQuizData.finalScore, persistedQuizData.incorrectQuestions, persistedQuizData.submittedByTimeOut, sendDeliaEmailButton, emailStatusMessage, 'close');
            } else {
                console.error("No hay datos de la prueba guardados para enviar el correo.");
                emailStatusMessage.classList.remove('hidden');
                emailStatusMessage.textContent = 'Error: No se pudieron encontrar los datos de la prueba para enviar.';
                emailStatusMessage.style.color = '#dc2626';
            }
        });

        // --- INITIALIZATION ---
        window.onload = function() {
            displayTopics();
            // On page load, the app always starts on the initial screen.
            // The check for completion per ID happens when the user tries to start the quiz.
            showScreen('start-screen');
        };
    </script>
</body>
</html>
