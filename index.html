<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Ingl√©s - Step by Step Academy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        body {
            font-family: 'Open Sans', sans-serif; /* Default body font */
            background-color: #f7f9fc; /* Very light, cool grey background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
            -khtml-user-select: none; /* Konqueror HTML */
            -moz-user-select: none; /* Old versions of Firefox */
            -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently supported by Chrome, Edge, Opera and Firefox */
        }
        .container {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 18px 36px rgba(0, 0, 0, 0.12), 0 14px 24px rgba(0, 0, 0, 0.08); /* More pronounced, modern shadow */
            padding: 2.5rem;
            max-width: 800px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            transition: all 0.3s ease-in-out;
        }
        @media (min-width: 768px) {
            .container {
                padding: 3rem;
            }
        }
        h1, h2, h3 {
            font-family: 'Poppins', sans-serif; /* Poppins for headings */
        }
        .option-button {
            display: block;
            width: 100%;
            padding: 1.1rem 1.5rem;
            margin-bottom: 0.75rem;
            text-align: left;
            border: 2px solid #e0e7ee; /* Lighter subtle border */
            border-radius: 0.75rem;
            background-color: #ffffff; /* White background for options */
            color: #3f4a5a; /* Darker grey text */
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .option-button:hover {
            background-color: #e6f2ff; /* Light blue on hover */
            border-color: #6366f1; /* Indigo border on hover */
            color: #4338ca; /* Darker indigo text */
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.2); /* Indigo shadow on hover */
        }
        .option-button.selected {
            background-color: #c7d2fe; /* Light indigo background when selected */
            border-color: #4338ca; /* Darker indigo border */
            color: #312e81; /* Even darker indigo text */
            box-shadow: 0 2px 8px rgba(67, 56, 202, 0.2);
        }
        /* Style for multiple-select options (checkbox-like behavior) */
        .multiple-select-option {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 1.1rem 1.5rem;
            margin-bottom: 0.75rem;
            border: 2px solid #e0e7ee;
            border-radius: 0.75rem;
            background-color: #ffffff;
            color: #3f4a5a;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .multiple-select-option:hover {
            background-color: #e6f2ff;
            border-color: #6366f1;
            color: #4338ca;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.2);
        }
        .multiple-select-option.selected {
            background-color: #c7d2fe;
            border-color: #4338ca;
            color: #312e81;
            box-shadow: 0 2px 8px rgba(67, 56, 202, 0.2);
        }
        .multiple-select-option input[type="checkbox"] {
            margin-right: 1rem;
            transform: scale(1.5); /* Make checkbox larger */
            accent-color: #6366f1; /* Change checkbox color */
        }

        .main-button, .send-button {
            padding: 1rem 2rem;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15); /* More prominent shadow */
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .main-button {
            background-image: linear-gradient(to right, #6366f1, #4338ca); /* Indigo gradient */
            color: white;
        }
        .main-button:hover {
            background-image: linear-gradient(to right, #4338ca, #312e81); /* Darker indigo on hover */
            transform: translateY(-4px); /* Slightly more lift */
        }
        .main-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .main-button:disabled, .send-button:disabled {
            background-image: linear-gradient(to right, #cbd5e1, #94a3b8);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .send-button {
             background-image: linear-gradient(to right, #10b981, #059669); /* Emerald gradient */
             color: white;
        }
        .send-button:hover {
            background-image: linear-gradient(to right, #059669, #047857); /* Darker emerald on hover */
            transform: translateY(-4px);
        }
        .send-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e2e8f0;
            border-radius: 9999px;
            height: 12px;
            overflow: hidden;
            margin-top: 1rem;
        }
        .progress-bar {
            height: 100%;
            background-color: #6366f1; /* Indigo progress bar */
            width: 0%;
            border-radius: 9999px;
            transition: width 0.3s ease-out;
        }
        .direct-answer-input {
            width: 100%;
            padding: 1.1rem 1.5rem;
            border: 2px solid #e0e7ee;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            color: #3f4a5a;
        }
        .direct-answer-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1; /* Indigo spinner */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #final-thanks-message {
            text-align: center;
            font-size: 2.8rem;
            font-weight: 800; /* Even bolder for Poppins */
            color: #4338ca; /* Darker indigo */
            margin-top: 60px;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 1s ease-out, transform 1s ease-out;
            line-height: 1.3;
            position: fixed; /* Keep it centered even if main app is hidden */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000; /* Ensure it's on top */
            background-color: #ffffff; /* Add background for visibility */
            padding: 3rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
        }
        #final-thanks-message.show {
            opacity: 1;
            transform: translate(-50%, -50%);
        }
        .timer-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3f4a5a;
            background-color: #e6f2ff;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            margin-left: auto; /* Push to right */
            min-width: 120px;
            text-align: center;
        }
        .timer-display.low-time {
            color: #dc2626; /* Red for low time */
            background-color: #fee2e2;
        }
        .multi-part-question-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .multi-part-question-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .multi-part-question-item label {
            font-weight: 600;
            color: #4a5568;
        }
    </style>
</head>
<body>
    <div id="quiz-app" class="container">
        <div id="main-header" class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-blue-800 mb-2">Step by Step Academy</h1>
            <p class="text-lg text-gray-600 italic">"Tu camino al √©xito en ingl√©s, paso a paso."</p>
        </div>

        <div id="start-screen" class="text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">¬°Bienvenido a tu primera prueba!</h2>
            <h3 class="text-2xl font-bold text-blue-700 mb-4">M√≥dulo 1 de Ingl√©s B√°sico</h3>
            
            <div class="mb-4 space-y-3">
                <input type="text" id="user-name" placeholder="Tu Nombre" class="direct-answer-input" required>
                <input type="text" id="user-surname" placeholder="Tu Apellido" class="direct-answer-input" required>
                <input type="email" id="user-email" placeholder="Tu Correo Electr√≥nico" class="direct-answer-input" required>
                <input type="text" id="user-id-card" placeholder="Tu C√©dula de Identidad" class="direct-answer-input" required>
            </div>
            
            <div class="flex justify-center mt-6">
                <button id="start-quiz-button" class="main-button" disabled>Comenzar Prueba</button>
            </div>
        </div>

        <div id="instructions-screen" class="hidden text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Instrucciones de la Prueba</h2>
            <div class="text-left text-gray-700 text-lg space-y-4 mb-8">
                <p class="font-bold text-blue-700"><i class="fas fa-exclamation-triangle text-red-600 mr-2"></i> **Importante:** Solo tienes **una √∫nica oportunidad** para completar esta prueba.</p>
                <p class="font-bold text-blue-700"><i class="fas fa-star text-blue-600 mr-2"></i> Cada respuesta correcta vale 0.4 puntos. Puntuaci√≥n m√°xima: 20 puntos.</p>
                <p><i class="fas fa-book-reader text-blue-600 mr-2"></i> Lee cada √≠tem cuidadosamente antes de responder.</p>
                <p><i class="fas fa-check-square text-blue-600 mr-2"></i> Para los √≠tems de **selecci√≥n m√∫ltiple**, puedes elegir una o varias opciones. Cada opci√≥n correcta suma puntos.</p>
                <p><i class="fas fa-keyboard text-blue-600 mr-2"></i> Para los √≠tems de **respuesta directa**, escribe tu respuesta en el campo provisto. Aseg√∫rate de la ortograf√≠a y gram√°tica.</p>
                <p><i class="fas fa-arrows-alt-h text-blue-600 mr-2"></i> Puedes navegar entre los √≠tems usando los botones 'Atr√°s' y 'Siguiente'.</p>
                <p class="font-bold text-blue-700"><i class="fas fa-check-circle text-green-600 mr-2"></i> **Revisa cuidadosamente tus respuestas** antes de hacer clic en "Finalizar Prueba".</p>
                <p class="font-bold text-blue-700"><i class="fas fa-hourglass-half text-blue-600 mr-2"></i> El tiempo l√≠mite es de 120 minutos. ¬°Mucha suerte!</p>
            </div>
            <button id="start-first-question-button" class="main-button">Entendido, ¬°Comenzar!</button>
        </div>
        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <span id="question-counter" class="text-gray-600 font-medium text-lg"></span>
                <div id="timer-display" class="timer-display">00:00</div>
            </div>
            <div class="progress-bar-container mb-6"><div id="progress-bar" class="progress-bar"></div></div>
            <h2 id="question-text" class="text-2xl font-semibold text-gray-800 mb-6"></h2>
            <div id="options-container" class="flex flex-col gap-3"></div>
            <div class="flex justify-between gap-4 mt-8">
                <button id="prev-button" class="main-button w-1/2" disabled>Atr√°s</button>
                <button id="next-button" class="main-button w-1/2" disabled>Siguiente</button>
            </div>
        </div>

        <div id="results-screen" class="hidden text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">¬°Prueba Finalizada!</h2>
            
            <button id="send-delia-email-button" class="send-button mt-8 w-full">
                <i class="fas fa-save"></i> Guardar Resultados
            </button>
            <div id="email-status-message" class="text-sm mt-2 text-gray-600 hidden"></div>
        </div>
    </div>

    <div id="final-thanks-message" class="hidden">
        ¬°Gracias por completar la prueba!
    </div>

    <script>
        // EmailJS initialization
        (function() {
            // Se ha actualizado la PUBLIC_KEY aqu√≠
            emailjs.init("7FE4lqcCZ69cThSp_"); 
        })();

        // --- START OF QUIZ DATA ---
        const allQuestions = [
            {
                question: "Presentaci√≥n y saludos (formal/informal)<br>Which of the following are informal greetings? (Select all that apply) / ¬øCu√°les de las siguientes son saludos informales? (Selecciona todas las que apliquen):",
                type: "multiple-select",
                options: [
                    { text: "a) Hi", value: "a", isCorrect: true },
                    { text: "b) Good evening", value: "b", isCorrect: false },
                    { text: "c) Morning", value: "c", isCorrect: true },
                    { text: "d) Hello", value: "d", isCorrect: false },
                    { text: "e) How‚Äôs everything?", value: "e", isCorrect: true },
                    { text: "f) Good morning", value: "f", isCorrect: false },
                    { text: "g) How‚Äôs it going?", value: "g", isCorrect: true }
                ],
                topic: "Presentaci√≥n y saludos (formal/informal)",
                scoreParts: 4 // Number of correct options
            },
            {
                question: "Despedidas<br>Select the appropriate ways to say goodbye. / Selecciona las formas en que podemos despedirnos (Escoge todas las que apliquen):",
                type: "multiple-select",
                options: [
                    { text: "a) Bye", value: "a", isCorrect: true },
                    { text: "b) See you later", value: "b", isCorrect: true },
                    { text: "c) Good night", value: "c", isCorrect: true },
                    { text: "d) Hello", value: "d", isCorrect: false },
                    { text: "e) What‚Äôs up?", value: "e", isCorrect: false },
                    { text: "f) How do you do?", value: "f", isCorrect: false }, 
                    { text: "g) Good morning", value: "g", isCorrect: false }
                ],
                topic: "Despedidas",
                scoreParts: 4 // Number of correct options
            },
            {
                question: "D√≠as de la semana<br>Select the correct order. / Selecciona el orden correcto:",
                type: "single-choice",
                options: [
                    "a) Wednesday, Monday, Tuesday, Thursday, Friday, Saturday, Sunday",
                    "b) Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday",
                    "c) Monday, Thursday, Wednesday, Tuesday, Friday, Saturday, Sunday",
                    "d) Monday, Tuesday, Wednesday, Thursday, Friday, Sunday, Saturday"
                ],
                answer: "b) Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday",
                topic: "D√≠as de la semana",
                scoreParts: 1
            },
            {
                question: "Meses del a√±o<br>Which of these are months of the year? (Select all that apply) / ¬øCu√°les de estos son meses del a√±o? (Selecciona todas las que apliquen):",
                type: "multiple-select",
                options: [
                    { text: "a) January", value: "a", isCorrect: true },
                    { text: "b) Morning", value: "b", isCorrect: false },
                    { text: "c) Saturday", value: "c", isCorrect: false },
                    { text: "d) April", value: "d", isCorrect: true },
                    { text: "e) Friday", value: "e", isCorrect: false },
                    { text: "f) December", value: "f", isCorrect: true },
                    { text: "g) August", value: "g", isCorrect: true }
                ],
                topic: "Meses del a√±o",
                scoreParts: 4 // Number of correct options
            },
            {
                question: "N√∫meros cardinales y ordinales<br>Choose the correct ordinal numbers. / Escoge los n√∫meros ordinales:",
                type: "multiple-select",
                options: [
                    { text: "a) First", value: "a", isCorrect: true },
                    { text: "b) Three", value: "b", isCorrect: false },
                    { text: "c) Second", value: "c", isCorrect: true },
                    { text: "d) Twelve", "value": "d", isCorrect: false },
                    { text: "e) Third", value: "e", isCorrect: true },
                    { text: "f) Fifth", value: "f", isCorrect: true },
                    { text: "g) Eighteen", value: "g", isCorrect: false }
                ],
                topic: "N√∫meros cardinales y ordinales",
                scoreParts: 4 // Number of correct options
            },
            {
                question: "Verbo ‚ÄúTo be‚Äù (presente)<br>Choose the correct positive sentence with the verb ‚Äúto be‚Äù. / Selecciona las oraciones positivas que est√©n escritas correctamente:",
                type: "multiple-select",
                options: [
                    { text: "a) I is happy", value: "a", isCorrect: false },
                    { text: "b) She are tired", value: "b", isCorrect: false },
                    { text: "c) They are friends", value: "c", isCorrect: true },
                    { text: "d) You am busy", value: "d", isCorrect: false },
                    { text: "e) We are teachers", value: "e", isCorrect: true },
                    { text: "f) He are my brother", value: "f", isCorrect: false },
                    { text: "g) It is cold", value: "g", isCorrect: true }
                ],
                topic: "Verbo ‚ÄúTo be‚Äù (presente)",
                scoreParts: 3 // Number of correct options
            },
            {
                question: "Oraciones negativas con ‚ÄúTo be‚Äù<br>Complete the sentences with the correct negative form. / Completa las oraciones negativas con la forma correcta:",
                type: "multi-direct-answer",
                parts: [
                    { prompt: "1. I _______ a student.", answer: ["am not", "'m not"] }, 
                    { prompt: "2. They _____ at home.", answer: ["are not", "aren't"] }, 
                    { prompt: "3. He ______ a doctor.", answer: ["is not", "isn't"] },   
                    { prompt: "4. She _____ happy.", answer: ["is not", "isn't"] },
                    { prompt: "5. We ____ ready.", answer: ["are not", "aren't"] },
                    { prompt: "6. It ______ sunny.", answer: ["is not", "isn't"] },
                    { prompt: "7. You _______ tired.", answer: ["are not", "aren't"] } 
                ],
                topic: "Oraciones negativas con ‚ÄúTo be‚Äù",
                scoreParts: 7 
            },
            {
                question: "Interrogativas con ‚ÄúTo be‚Äù<br>Transform the following positive sentences into interrogative sentences. / Transforma las siguientes oraciones positivas a oraciones interrogativas:",
                type: "multi-direct-answer",
                parts: [
                    { prompt: "a) You are okay", answer: ["Are you okay?"] }, 
                    { prompt: "b) They are hungry", answer: ["Are they hungry?"] },
                    { prompt: "c) He is a teacher", answer: ["Is he a teacher?"] },
                    { prompt: "d) We are ready", answer: ["Are we ready?"] },
                    { prompt: "e) She is at school", answer: ["Is she at school?"] },
                    { prompt: "f) They are friends", answer: ["Are they friends?"] }
                ],
                topic: "Interrogativas con ‚ÄúTo be‚Äù",
                scoreParts: 6 
            },
            {
                question: "A vs. An<br>Write the correct article for each noun. / Escribe el art√≠culo correcto para cada sustantivo (Opci√≥n correcta: a/an seg√∫n el caso):",
                type: "multi-direct-answer",
                parts: [
                    { prompt: "a) __ apple", answer: ["an"] },
                    { prompt: "b) __ orange", answer: ["an"] },
                    { prompt: "c) __ book", answer: ["a"] },
                    { prompt: "d) __ umbrella", answer: ["an"] },
                    { prompt: "e) __ elephant", answer: ["an"] }, 
                    { prompt: "f) __ pen", answer: ["a"] },
                    { prompt: "g) __ hour", answer: ["an"] }
                ],
                topic: "A vs. An",
                scoreParts: 7
            },
            {
                question: "Nouns y plural nouns<br>Choose the correct plural form. / Escoge el sustantivo plural correcto:",
                type: "multiple-select",
                options: [
                    { text: "a) Baby ‚Üí Babys", value: "a", isCorrect: false },
                    { text: "b) Child ‚Üí Childs", value: "b", isCorrect: false },
                    { text: "c) Man ‚Üí Men", value: "c", isCorrect: true },
                    { text: "d) Woman ‚Üí Women", value: "d", isCorrect: true },
                    { text: "e) Mouse ‚Üí Mouses", value: "e", isCorrect: false },
                    { text: "f) Tooth ‚Üí Teeth", value: "f", isCorrect: true },
                    { text: "g) Foot ‚Üí Feet", value: "g", isCorrect: true }
                ],
                topic: "Nouns y plural nouns",
                scoreParts: 4 // Number of correct options
            },
            {
                question: "Partes del cuerpo<br>Translate the following body parts into Spanish. / Traduce las siguientes partes del cuerpo al espa√±ol:",
                type: "multi-direct-answer",
                parts: [
                    { prompt: "1. Hand", answer: ["mano"] },
                    { prompt: "2. Foot", answer: ["pie"] },
                    { prompt: "3. Head", answer: ["cabeza"] }
                ],
                topic: "Partes del cuerpo",
                scoreParts: 3 // 3 correct parts
            },
            {
                question: "Familia (integrantes)<br>Translate the following family members into Spanish. / Traduce los siguientes miembros de la familia al espa√±ol:",
                type: "multi-direct-answer",
                parts: [
                    { prompt: "1. Mother", answer: ["madre"] },
                    { prompt: "2. Father", answer: ["padre"] },
                    { prompt: "3. Sister", answer: ["hermana"] }
                ],
                topic: "Familia (integrantes)",
                scoreParts: 3 // 3 correct parts
            }
        ];
        // --- END OF QUIZ DATA ---

        // --- GLOBAL QUIZ VARIABLES ---
        let shuffledQuestions = [];
        let currentQuestionIndex = 0;
        let rawScore = 0; 
        let userAnswers = [];
        let incorrectQuestionsData = [];
        let correctQuestionsData = []; // Added for correct answers feedback
        let selectedOptionElement = null; 
        let directAnswerInputs = []; 
        let userName = '', userSurname = '', userEmail = '', userIdCard = ''; 
        let timerInterval; 
        let remainingTime; 
        let quizSubmittedByTimeOut = false; 
        let quizStartTime; // To record when quiz officially starts

        // --- DOM ELEMENTS ---
        let quizAppContainer;
        let mainHeader;
        let startScreen;
        let instructionsScreen; 
        let quizScreen;
        let resultsScreen;
        let startQuizButton;
        let startFirstQuestionButton; 
        let userNameInput;
        let userSurnameInput;
        let userEmailInput;
        let userIdCardInput;
        let questionCounter;
        let progressBar;
        let questionText;
        let optionsContainer;
        let nextButton;
        let prevButton; 
        let sendEmailButton; 
        let statusMessage; 
        let finalThanksMessage;
        let timerDisplay; 

        // --- CONSTANTS ---
        const NUM_MAIN_QUESTIONS = allQuestions.length; 
        const QUIZ_DURATION_MINUTES = 120; 
        const MAX_RAW_SCORE = 50; 
        const FINAL_MAX_SCORE = 20; 
        const QUIZ_COMPLETED_PREFIX = 'stepByStepQuizCompleted_'; 
        const QUIZ_DATA_STORAGE_KEY = 'stepByStepQuizData'; 

        // Authorized IDs (cedulas)
        const authorizedIdNumbers = [
            '3717064', // UNLIMITED_ACCESS_ID (kept)
            '21291785', 
            '19399996', 
            '10793197', 
            '18603986', 
            '7585443', 
            '7920622', 
            '10182240', 
            '31725050', 
            '33619493'
        ];
        const UNLIMITED_ACCESS_ID = '3717064'; 

        const incorrectFeedbackPhrases = [
            "¬°Casi lo logras! La respuesta correcta era: [respuesta esperada]. ¬°Sigue practicando!",
            "Un peque√±o error. La respuesta correcta era: [respuesta esperada]. ¬°No te rindas!",
            "Esa no es la respuesta. La correcta era: [respuesta esperada]. ¬°Puedes hacerlo mejor!",
            "¬°Int√©ntalo de nuevo! La respuesta correcta era: [respuesta esperada]. ¬°La pr√°ctica hace al maestro!"
        ];

        const correctFeedbackPhrases = [
            "¬°Excelente! Esa es la respuesta correcta.",
            "¬°Muy bien! Respuesta acertada.",
            "¬°Correcto! Sigue as√≠.",
            "¬°Incre√≠ble! Lo hiciste de maravilla."
        ];

        function getRandomFeedback(phrases, expectedAnswer) {
            const phrase = phrases[Math.floor(Math.random() * phrases.length)];
            return phrase.replace("[respuesta esperada]", expectedAnswer);
        }

        // --- GENERAL UI & NAVIGATION ---
        function showScreen(screenId) {
            startScreen.classList.add('hidden');
            instructionsScreen.classList.add('hidden'); 
            quizScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            finalThanksMessage.classList.add('hidden'); 

            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
                quizAppContainer.classList.remove('hidden'); 
            } else {
                console.error(`Error: Screen with ID '${screenId}' not found.`);
                quizAppContainer.classList.add('hidden'); 
            }
            
            if (screenId === 'quiz-screen' || screenId === 'instructions-screen') { 
                mainHeader.classList.add('hidden'); 
            } else {
                mainHeader.classList.remove('hidden'); 
            }

            if (screenId === 'start-screen') {
                userNameInput.value = '';
                userSurnameInput.value = '';
                userEmailInput.value = '';
                userIdCardInput.value = '';
                checkInputsAndEnableStartButton(); 
            }
        }

        function displayMessageBox(title, message) {
            alert(`${title}\n\n${message}`);
        }

        // --- TIMER LOGIC ---
        function startTimer() {
            quizStartTime = new Date(); 
            remainingTime = QUIZ_DURATION_MINUTES * 60; 
            updateTimerDisplay(); 

            timerInterval = setInterval(() => {
                remainingTime--;
                updateTimerDisplay();

                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    autoSubmitQuiz();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timerDisplay.textContent = formattedTime;

            if (remainingTime <= 60) { 
                timerDisplay.classList.add('low-time');
            } else {
                timerDisplay.classList.remove('low-time');
            }
        }

        function autoSubmitQuiz() {
            quizSubmittedByTimeOut = true; 
            optionsContainer.querySelectorAll('button, input').forEach(element => element.disabled = true); 
            nextButton.disabled = true;
            prevButton.disabled = true; 
            
            displayMessageBox("¬°Tiempo Agotado!", "El tiempo para completar la prueba ha terminado. Tus respuestas se enviar√°n autom√°ticamente.");
            submitQuiz(); 
        }

        // --- QUIZ LOGIC ---

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; 
            }
        }

        /**
         * Reorders questions to interleave selection-based and writing-based questions.
         * Shuffles each category independently and then alternates them.
         * @param {Array} questions - The array of all questions.
         * @returns {Array} The reordered array of questions.
         */
        function interleaveQuestions(questions) {
            const selectionQuestions = questions.filter(q => q.type === "single-choice" || q.type === "multiple-select");
            const writingQuestions = questions.filter(q => q.type === "direct-answer" || q.type === "multi-direct-answer");

            shuffleArray(selectionQuestions);
            shuffleArray(writingQuestions);

            const interleaved = [];
            let sIdx = 0;
            let wIdx = 0;

            while (sIdx < selectionQuestions.length || wIdx < writingQuestions.length) {
                // Prioritize adding a selection question if available
                if (sIdx < selectionQuestions.length) {
                    interleaved.push(selectionQuestions[sIdx]);
                    sIdx++;
                }
                // Then add a writing question if available
                if (wIdx < writingQuestions.length) {
                    interleaved.push(writingQuestions[wIdx]);
                    wIdx++;
                }
            }
            console.log("Questions interleaved:", interleaved.map(q => q.type));
            return interleaved;
        }

        /**
         * Helper function to check if a user's answer is correct,
         * supporting multiple correct answers for direct input types.
         * @param {string} userAnswer - The answer provided by the user.
         * @param {string|string[]} correctAnswer - The correct answer(s). Can be a single string or an array of strings.
         * @returns {boolean} True if the user's answer is correct, false otherwise.
         */
        function isAnswerCorrect(userAnswer, correctAnswer) {
            const normalizedUserAnswer = (userAnswer || '').toLowerCase().trim();
            if (Array.isArray(correctAnswer)) {
                const normalizedCorrectAnswers = correctAnswer.map(a => a.toLowerCase().trim());
                const isCorrect = normalizedCorrectAnswers.includes(normalizedUserAnswer);
                return isCorrect;
            } else {
                const normalizedCorrectAnswer = correctAnswer.toLowerCase().trim();
                const isCorrect = normalizedUserAnswer === normalizedCorrectAnswer;
                return isCorrect;
            }
        }

        function checkInputsAndEnableStartButton() {
            const isNameValid = userNameInput.value.trim() !== '';
            const isSurnameValid = userSurnameInput.value.trim() !== '';
            const isEmailValid = userEmailInput.value.trim() !== '' && userEmailInput.checkValidity();
            const isIdCardValid = authorizedIdNumbers.includes(userIdCardInput.value.trim()) || userIdCardInput.value.trim() === UNLIMITED_ACCESS_ID;

            startQuizButton.disabled = !(isNameValid && isSurnameValid && isEmailValid && isIdCardValid);
        }

        function startQuiz() {
            userName = userNameInput.value.trim();
            userSurname = userSurnameInput.value.trim();
            userEmail = userEmailInput.value.trim();
            userIdCard = userIdCardInput.value.trim();

            const isNameValid = userName !== '';
            const isSurnameValid = userSurname !== '';
            const isEmailValid = userEmail !== '' && userEmailInput.checkValidity();
            const isIdCardRegistered = authorizedIdNumbers.includes(userIdCard);
            const isUnlimitedAccess = userIdCard === UNLIMITED_ACCESS_ID;

            if (!isNameValid || !isSurnameValid || !isEmailValid || (!isIdCardRegistered && !isUnlimitedAccess)) {
                displayMessageBox("Error de Inicio", "Por favor, completa todos los campos correctamente y aseg√∫rate de que tu c√©dula est√© registrada o sea la de acceso ilimitado.");
                return;
            }

            // Corrected logic: only check localStorage for completion if it's NOT the unlimited access ID
            if (!isUnlimitedAccess) {
                const quizCompletedForThisID = localStorage.getItem(QUIZ_COMPLETED_PREFIX + userIdCard) === 'true';
                if (quizCompletedForThisID) {
                    displayMessageBox("Prueba Ya Completada", `La c√©dula ${userIdCard} ya ha presentado esta prueba. No se permite un nuevo intento. La aplicaci√≥n se cerrar√° autom√°ticamente.`);
                    setTimeout(() => {
                        quizAppContainer.classList.add('hidden');
                        finalThanksMessage.classList.remove('hidden');
                        finalThanksMessage.classList.add('show');
                    }, 1000);
                    return;
                }
            } else {
                console.log(`C√©dula ${UNLIMITED_ACCESS_ID} detectada: Acceso ilimitado, omitiendo la verificaci√≥n de finalizaci√≥n.`);
            }

            showScreen('instructions-screen');
            currentQuestionIndex = 0;
            rawScore = 0;
            userAnswers = new Array(NUM_MAIN_QUESTIONS).fill(null);
            incorrectQuestionsData = [];
            correctQuestionsData = []; // Reset correct answers data
            quizSubmittedByTimeOut = false;
            statusMessage.classList.add('hidden');
            statusMessage.textContent = '';
            
            // Apply interleaving
            shuffledQuestions = interleaveQuestions(allQuestions); 
        }

        function startFirstQuestion() {
            showScreen('quiz-screen');
            startTimer();
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQuestionIndex >= shuffledQuestions.length) {
                stopTimer();
                submitQuiz();
                return;
            }

            const question = shuffledQuestions[currentQuestionIndex];
            questionText.innerHTML = question.question;
            optionsContainer.innerHTML = '';
            selectedOptionElement = null;
            directAnswerInputs = [];

            // Determine button text and action
            if (currentQuestionIndex === shuffledQuestions.length - 1) {
                nextButton.textContent = 'Finalizar Prueba';
                nextButton.disabled = false; // Always enable 'Finalizar Prueba' button
            } else {
                nextButton.textContent = 'Siguiente';
                nextButton.disabled = true; // Default to disabled for 'Siguiente'
            }

            if (question.type === "single-choice") {
                question.options.forEach(optionText => {
                    const button = document.createElement('button');
                    button.textContent = optionText;
                    button.classList.add('option-button');
                    button.addEventListener('click', () => {
                        if (selectedOptionElement) selectedOptionElement.classList.remove('selected');
                        selectedOptionElement = button;
                        selectedOptionElement.classList.add('selected');
                        userAnswers[currentQuestionIndex] = optionText;
                        if (currentQuestionIndex < shuffledQuestions.length - 1) { 
                            nextButton.disabled = false;
                        }
                    });
                    optionsContainer.appendChild(button);
                    if (userAnswers[currentQuestionIndex] === optionText) {
                        button.classList.add('selected');
                        selectedOptionElement = button;
                        if (currentQuestionIndex < shuffledQuestions.length - 1) { 
                            nextButton.disabled = false;
                        }
                    }
                });
            } else if (question.type === "multiple-select") {
                const selectedValues = userAnswers[currentQuestionIndex] || [];
                question.options.forEach(option => {
                    const label = document.createElement('label');
                    label.classList.add('multiple-select-option');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = option.value;
                    checkbox.checked = selectedValues.includes(option.value);
                    checkbox.addEventListener('change', () => {
                        let currentSelections = userAnswers[currentQuestionIndex] || [];
                        if (checkbox.checked) {
                            if (!currentSelections.includes(checkbox.value)) {
                                currentSelections.push(checkbox.value);
                            }
                        } else {
                            currentSelections = currentSelections.filter(val => val !== checkbox.value);
                        }
                        userAnswers[currentQuestionIndex] = currentSelections;
                        label.classList.toggle('selected', checkbox.checked);
                        if (currentQuestionIndex < shuffledQuestions.length - 1) { 
                             nextButton.disabled = currentSelections.length === 0;
                        }
                    });
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(option.text));
                    optionsContainer.appendChild(label);

                    if (checkbox.checked) {
                        label.classList.add('selected');
                        if (currentQuestionIndex < shuffledQuestions.length - 1) { 
                            nextButton.disabled = false;
                        }
                    }
                });
                if (selectedValues.length > 0 && currentQuestionIndex < shuffledQuestions.length - 1) {
                     nextButton.disabled = false;
                }
            } else if (question.type === "direct-answer") {
                const input = document.createElement('input');
                input.type = 'text';
                input.classList.add('direct-answer-input');
                input.placeholder = 'Escribe aqu√≠ la respuesta correcta...'; 
                input.value = userAnswers[currentQuestionIndex] || '';
                input.addEventListener('input', () => {
                    userAnswers[currentQuestionIndex] = input.value;
                    if (currentQuestionIndex < shuffledQuestions.length - 1) { 
                        nextButton.disabled = input.value.trim() === '';
                    }
                });
                optionsContainer.appendChild(input);
                directAnswerInputs.push(input);
                if (input.value.trim() !== '' && currentQuestionIndex < shuffledQuestions.length - 1) {
                    nextButton.disabled = false;
                }
            } else if (question.type === "multi-direct-answer") {
                const container = document.createElement('div');
                container.classList.add('multi-part-question-container');
                
                if (!Array.isArray(userAnswers[currentQuestionIndex]) || userAnswers[currentQuestionIndex].length !== question.parts.length) {
                    userAnswers[currentQuestionIndex] = new Array(question.parts.length).fill('');
                }
                const currentPartAnswers = userAnswers[currentQuestionIndex]; 

                question.parts.forEach((part, index) => {
                    const item = document.createElement('div');
                    item.classList.add('multi-part-question-item');
                    const label = document.createElement('label');
                    label.textContent = part.prompt;
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.classList.add('direct-answer-input');
                    input.placeholder = 'Escribe aqu√≠ la respuesta correcta...'; 
                    
                    input.value = currentPartAnswers[index]; 

                    input.addEventListener('input', () => {
                        currentPartAnswers[index] = input.value;
                        
                        if (currentQuestionIndex < shuffledQuestions.length - 1) {
                            nextButton.disabled = !currentPartAnswers.every(answer => answer.trim() !== '');
                        }
                    });
                    
                    item.appendChild(label);
                    item.appendChild(input);
                    container.appendChild(item);
                    directAnswerInputs.push(input); 
                });
                optionsContainer.appendChild(container);

                if (currentQuestionIndex < shuffledQuestions.length - 1) {
                    nextButton.disabled = !currentPartAnswers.every(answer => answer.trim() !== '');
                }
            }

            questionCounter.textContent = `Pregunta ${currentQuestionIndex + 1} de ${NUM_MAIN_QUESTIONS}`;
            updateProgressBar();
            prevButton.disabled = currentQuestionIndex === 0;
        }


        function updateProgressBar() {
            const progress = ((currentQuestionIndex + 1) / NUM_MAIN_QUESTIONS) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function calculateScore() {
            rawScore = 0;
            incorrectQuestionsData = []; 
            correctQuestionsData = []; // Clear previous data

            shuffledQuestions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                let isQuestionCorrect = false;
                let feedback = '';
                const baseQuestionText = question.question.split('<br>')[0]; 

                if (question.type === "single-choice") {
                    if (userAnswer === question.answer) {
                        rawScore += question.scoreParts;
                        isQuestionCorrect = true;
                        feedback = getRandomFeedback(correctFeedbackPhrases, question.answer);
                    } else {
                        feedback = getRandomFeedback(incorrectFeedbackPhrases, question.answer);
                    }
                } else if (question.type === "multiple-select") {
                    const correctOptions = question.options.filter(opt => opt.isCorrect).map(opt => opt.value);
                    const userSelectedOptions = userAnswer || [];
                    let correctSelectionsCount = 0;
                    let incorrectSelectionsCount = 0;

                    question.options.forEach(option => {
                        const userHasSelected = userSelectedOptions.includes(option.value);
                        if (option.isCorrect && userHasSelected) {
                            correctSelectionsCount++;
                        } else if (!option.isCorrect && userHasSelected) {
                            incorrectSelectionsCount++;
                        }
                    });

                    if (correctSelectionsCount === correctOptions.length && incorrectSelectionsCount === 0) {
                        rawScore += question.scoreParts;
                        isQuestionCorrect = true;
                        const correctExpectedText = correctOptions.map(val => question.options.find(o => o.value === val).text).join(', ');
                        feedback = getRandomFeedback(correctFeedbackPhrases, correctExpectedText);
                    } else {
                        const correctExpectedText = correctOptions.map(val => question.options.find(o => o.value === val).text).join(', ');
                        let fullExpectedAnswer = `"${correctExpectedText}"`;
                        
                        // Build detailed incorrect feedback
                        let detailedFeedback = getRandomFeedback(incorrectFeedbackPhrases, fullExpectedAnswer);
                        const missingCorrect = correctOptions.filter(opt => !userSelectedOptions.includes(opt));
                        const extraIncorrect = userSelectedOptions.filter(opt => !correctOptions.includes(opt));
                        
                        if (missingCorrect.length > 0) detailedFeedback += ` Te faltaron: ${missingCorrect.map(val => question.options.find(o => o.value === val).text).join(', ')}.`;
                        if (extraIncorrect.length > 0) detailedFeedback += ` Seleccionaste incorrectamente: ${extraIncorrect.map(val => question.options.find(o => o.value === val).text).join(', ')}.`;
                        
                        feedback = detailedFeedback;
                    }

                } else if (question.type === "direct-answer") {
                    const expectedAnswer = Array.isArray(question.answer) ? question.answer.join(' o ') : question.answer;
                    if (isAnswerCorrect(userAnswer, question.answer)) {
                        rawScore += question.scoreParts;
                        isQuestionCorrect = true;
                        feedback = getRandomFeedback(correctFeedbackPhrases, expectedAnswer);
                    } else {
                        feedback = getRandomFeedback(incorrectFeedbackPhrases, expectedAnswer);
                    }
                } else if (question.type === "multi-direct-answer") {
                    let partsCorrect = 0;
                    const currentQuestionUserAnswer = Array.isArray(userAnswer) ? userAnswer : new Array(question.parts.length).fill('');
                    
                    let expectedAnswersParts = [];
                    question.parts.forEach((part, partIndex) => {
                        const partUserAnswer = currentQuestionUserAnswer[partIndex];
                        if (isAnswerCorrect(partUserAnswer, part.answer)) {
                            partsCorrect++;
                        }
                        const promptText = part.prompt ? part.prompt.replace('__', '') : `Parte ${partIndex + 1}`;
                        expectedAnswersParts.push(`"${promptText} ${Array.isArray(part.answer) ? part.answer.join(' o ') : part.answer}"`);
                    });
                    const fullExpectedAnswer = expectedAnswersParts.join(', ');

                    if (partsCorrect === question.parts.length) {
                        rawScore += question.scoreParts;
                        isQuestionCorrect = true;
                        feedback = getRandomFeedback(correctFeedbackPhrases, fullExpectedAnswer);
                    } else {
                        feedback = getRandomFeedback(incorrectFeedbackPhrases, fullExpectedAnswer);
                    }
                }

                if (!isQuestionCorrect) {
                    incorrectQuestionsData.push({
                        questionText: baseQuestionText,
                        userAnswer: userAnswer,
                        feedback: feedback
                    });
                } else {
                    correctQuestionsData.push({ // Store correct answers data as well
                        questionText: baseQuestionText,
                        userAnswer: userAnswer,
                        feedback: feedback
                    });
                }
            });
        }
        
        function submitQuiz() {
            stopTimer(); 
            calculateScore();

            const finalScore = (rawScore / MAX_RAW_SCORE) * FINAL_MAX_SCORE; 

            const quizEndTime = new Date();
            const timeTakenSeconds = Math.round((quizEndTime - quizStartTime) / 1000);
            const minutesTaken = Math.floor(timeTakenSeconds / 60);
            const secondsTaken = timeTakenSeconds % 60;
            const responseTimeFormatted = `${minutesTaken} min ${secondsTaken} seg`;

            let comprehensionLevel;
            let testStatus;

            if (finalScore >= 16) {
                comprehensionLevel = "Avanzado";
                testStatus = "Aprobado";
            } else if (finalScore >= 10 && finalScore < 16) {
                comprehensionLevel = "Intermedio";
                testStatus = "Aprobado";
            } else {
                comprehensionLevel = "B√°sico";
                testStatus = "Reprobado";
            }

            let fullFeedbackEmail = "Resumen de la Prueba:\n\n";

            if (correctQuestionsData.length > 0) {
                fullFeedbackEmail += "--- Respuestas Correctas ---\n";
                correctQuestionsData.forEach((item, index) => {
                    fullFeedbackEmail += `Pregunta: ${item.questionText}\n`;
                    fullFeedbackEmail += `Tu Respuesta: ${Array.isArray(item.userAnswer) ? item.userAnswer.join(', ') : (item.userAnswer || 'No respondida')}\n`;
                    fullFeedbackEmail += `Retroalimentaci√≥n: ${item.feedback}\n\n`;
                });
            } else {
                fullFeedbackEmail += "No hay preguntas correctas.\n\n";
            }
            
            if (incorrectQuestionsData.length > 0) {
                fullFeedbackEmail += "--- Preguntas Incorrectas ---\n";
                incorrectQuestionsData.forEach((item, index) => {
                    fullFeedbackEmail += `Pregunta: ${item.questionText}\n`;
                    fullFeedbackEmail += `Tu Respuesta: ${Array.isArray(item.userAnswer) ? item.userAnswer.join(', ') : (item.userAnswer || 'No respondida')}\n`;
                    fullFeedbackEmail += `Retroalimentaci√≥n: ${item.feedback}\n\n`;
                });
            } else {
                fullFeedbackEmail += "¬°Excelente! No hay preguntas incorrectas. ¬°Felicidades!\n\n";
            }


            if (userIdCard !== UNLIMITED_ACCESS_ID) {
                localStorage.setItem(QUIZ_COMPLETED_PREFIX + userIdCard, 'true');
                console.log(`Quiz completion status saved for ID: ${userIdCard}`);
            } else {
                console.log(`Quiz completed with UNLIMITED_ACCESS_ID: Not saving completion status.`);
            }

            showScreen('results-screen');

            const templateParams = {
                student_id_card: userIdCard, 
                score: Math.round(finalScore), 
                comprehension_level: comprehensionLevel, 
                test_status: testStatus, 
                response_time: responseTimeFormatted, 
                user_name: userName, 
                user_surname: userSurname, 
                user_email: userEmail, 
                full_feedback: fullFeedbackEmail, 
                to_email: 'redaccionseoepub@gmail.com' 
            };

            statusMessage.classList.remove('hidden');
            statusMessage.textContent = 'Enviando resultados...';
            sendEmailButton.disabled = true; 

            // Se han usado los SERVICE_ID y TEMPLATE_ID que proporcionaste.
            // Aseg√∫rate de que tu Public Key est√© bien configurada en emailjs.init("...")
            emailjs.send('service_plel29w', 'template_bo27pgn', templateParams)
                .then(function(response) {
                    console.log('Correo enviado exitosamente!', response.status, response.text);
                    statusMessage.textContent = 'Resultados enviados exitosamente. ¬°Gracias!';
                    sendEmailButton.classList.add('hidden'); 
                    setTimeout(() => {
                        quizAppContainer.classList.add('hidden');
                        finalThanksMessage.classList.remove('hidden');
                        finalThanksMessage.classList.add('show');
                    }, 2000); 
                }, function(error) {
                    console.error('Error al enviar el correo:', error);
                    statusMessage.textContent = 'Hubo un error al enviar tus resultados. Por favor, contacta al soporte.';
                    sendEmailButton.disabled = false; 
                });
        }

        // --- EVENT LISTENERS & INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Get DOM elements
            quizAppContainer = document.getElementById('quiz-app');
            mainHeader = document.getElementById('main-header');
            startScreen = document.getElementById('start-screen');
            instructionsScreen = document.getElementById('instructions-screen');
            quizScreen = document.getElementById('quiz-screen');
            resultsScreen = document.getElementById('results-screen');
            startQuizButton = document.getElementById('start-quiz-button');
            startFirstQuestionButton = document.getElementById('start-first-question-button');
            userNameInput = document.getElementById('user-name');
            userSurnameInput = document.getElementById('user-surname');
            userEmailInput = document.getElementById('user-email');
            userIdCardInput = document.getElementById('user-id-card');
            questionCounter = document.getElementById('question-counter');
            progressBar = document.getElementById('progress-bar');
            questionText = document.getElementById('question-text');
            optionsContainer = document.getElementById('options-container');
            nextButton = document.getElementById('next-button');
            prevButton = document.getElementById('prev-button');
            sendEmailButton = document.getElementById('send-delia-email-button'); 
            statusMessage = document.getElementById('email-status-message');
            finalThanksMessage = document.getElementById('final-thanks-message');
            timerDisplay = document.getElementById('timer-display');

            // Event Listeners
            startQuizButton.addEventListener('click', startQuiz);
            startFirstQuestionButton.addEventListener('click', startFirstQuestion);

            // Input field listeners for validation
            userNameInput.addEventListener('input', checkInputsAndEnableStartButton);
            userSurnameInput.addEventListener('input', checkInputsAndEnableStartButton);
            userEmailInput.addEventListener('input', checkInputsAndEnableStartButton);
            userIdCardInput.addEventListener('input', checkInputsAndEnableStartButton);

            nextButton.addEventListener('click', () => {
                const question = shuffledQuestions[currentQuestionIndex];
                let isCurrentQuestionAnswered = true; 

                if (question.type === "single-choice" || question.type === "direct-answer") {
                    if (!userAnswers[currentQuestionIndex] || userAnswers[currentQuestionIndex].trim() === '') {
                        isCurrentQuestionAnswered = false;
                    }
                } else if (question.type === "multiple-select") {
                    if (!userAnswers[currentQuestionIndex] || userAnswers[currentQuestionIndex].length === 0) {
                        isCurrentQuestionAnswered = false;
                    }
                } else if (question.type === "multi-direct-answer") {
                    const currentPartAnswers = userAnswers[currentQuestionIndex];
                    if (!currentPartAnswers || !currentPartAnswers.every(answer => answer.trim() !== '')) {
                        isCurrentQuestionAnswered = false;
                    }
                }
                
                if (currentQuestionIndex === shuffledQuestions.length - 1) {
                    console.log("Attempting to finalize quiz (last question).");
                    console.log("User's answer for last question:", userAnswers[currentQuestionIndex]);
                    console.log("Is current question answered according to validation?", isCurrentQuestionAnswered);

                    if (isCurrentQuestionAnswered) {
                        stopTimer();
                        submitQuiz();
                    } else {
                        if (question.type === "multi-direct-answer") {
                            displayMessageBox("Advertencia", "Por favor, completa todas las partes de la √∫ltima pregunta antes de finalizar.");
                        } else {
                            displayMessageBox("Advertencia", "Por favor, completa la √∫ltima pregunta antes de finalizar.");
                        }
                    }
                } else { 
                    if (isCurrentQuestionAnswered) {
                        currentQuestionIndex++;
                        loadQuestion();
                    } else {
                        if (question.type === "multi-direct-answer") {
                            displayMessageBox("Advertencia", "Por favor, completa todas las partes de la pregunta antes de continuar.");
                        } else {
                            displayMessageBox("Advertencia", "Por favor, completa la respuesta antes de continuar.");
                        }
                    }
                }
            });

            prevButton.addEventListener('click', () => {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    loadQuestion();
                }
            });
            
            sendEmailButton.addEventListener('click', submitQuiz);

            showScreen('start-screen');
        });
    </script>
</body>
</html>
